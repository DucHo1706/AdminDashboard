@page "/Statistics"
@page "/Admin/Statistics"
@using AdminDashboard.Models
@using AdminDashboard.Services
@using AdminDashboard.TransportDBContext
@using AdminDashboard.Areas.Admin.Components
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using Microsoft.Data.SqlClient
@using DonHangVM = AdminDashboard.Areas.Admin.Components.DonHangViewModel
@using NguoiDungVM = AdminDashboard.Areas.Admin.Components.NguoiDungViewModel
@attribute [Authorize(Roles = "Admin")]
@inject Db27524Context Context
@inject IPaginationService PaginationService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<div class="statistics-container">
    <!-- Error Alert -->
    @if (HasError)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>L·ªói!</strong> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
        </div>
    }

    <!-- Header -->
    <div class="main-title-container mb-4">
        <h2 class="dashboard-main-title">
            <i class="bi bi-bar-chart-line-fill"></i> üìä Th·ªëng K√™ H·ªá Th·ªëng
        </h2>
    </div>

    <!-- T·ªïng Quan Th·ªëng K√™ - Compact Layout -->
    <div class="row mb-3">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-primary">
                <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Kh√°ch H√†ng</div>
                    <div class="stat-value">@TongKhachHang</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-success">
                <div class="stat-icon"><i class="bi bi-receipt"></i></div>
                <div class="stat-content">
                    <div class="stat-label">ƒê∆°n H√†ng</div>
                    <div class="stat-value">@TongDonHang</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-warning">
                <div class="stat-icon"><i class="bi bi-calendar-day"></i></div>
                <div class="stat-content">
                    <div class="stat-label">H√¥m Nay</div>
                    <div class="stat-value-small">@DoanhThuHomNay.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-info">
                <div class="stat-icon"><i class="bi bi-calendar-month"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Th√°ng N√†y</div>
                    <div class="stat-value-small">@DoanhThuThangNay.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-8 col-sm-12 mb-2">
            <div class="stat-card-compact bg-gradient">
                <div class="stat-icon"><i class="bi bi-cash-coin"></i></div>
                <div class="stat-content">
                    <div class="stat-label">T·ªïng Doanh Thu</div>
                    <div class="stat-value-large">@DoanhThuTong.ToString("N0") VNƒê</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs Navigation -->
    <ul class="nav nav-tabs mb-3" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == "khachhang" ? "active" : "")" 
                    @onclick='async () => await SetActiveTab("khachhang")'
                    type="button" role="tab">
                <i class="bi bi-people"></i> Kh√°ch H√†ng
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == "donhang" ? "active" : "")" 
                    @onclick='async () => await SetActiveTab("donhang")'
                    type="button" role="tab">
                <i class="bi bi-cart"></i> ƒê∆°n H√†ng
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link @(ActiveTab == "doanhthu" ? "active" : "")" 
                    @onclick='async () => await SetActiveTab("doanhthu")'
                    type="button" role="tab">
                <i class="bi bi-graph-up"></i> Doanh Thu
            </button>
        </li>
    </ul>

    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Tab Kh√°ch H√†ng -->
        @if (ActiveTab == "khachhang")
        {
            <div class="tab-pane fade show active" role="tabpanel">
                <!-- Th·ªëng k√™ theo ƒë·ªô tu·ªïi -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Th·ªëng K√™ Kh√°ch H√†ng Theo ƒê·ªô Tu·ªïi</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @foreach (var item in ThongKeTheoDoTuoi)
                            {
                                <div class="col-md-4 col-sm-6 mb-3">
                                    <div class="age-stat-item">
                                        <div class="age-label">@item.Key</div>
                                        <div class="age-value">@item.Value <small>kh√°ch h√†ng</small></div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

                <!-- Danh s√°ch kh√°ch h√†ng -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-list-ul"></i> Danh S√°ch Kh√°ch H√†ng</h5>
                    </div>
                    <div class="card-body">
                        <KhachHangList 
                            KhachHangs="KhachHangs" 
                            DonHangPageIndex="DonHangPageIndex"
                            OnPageChange="HandleKhachHangPageChange" />
                    </div>
                </div>
            </div>
        }

        <!-- Tab ƒê∆°n H√†ng -->
        @if (ActiveTab == "donhang")
        {
            <div class="tab-pane fade show active" role="tabpanel">
                <!-- Th·ªëng k√™ ƒë∆°n h√†ng theo th·ªùi gian - Compact -->
                <div class="row mb-3">
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact bg-primary">
                            <div class="stat-icon"><i class="bi bi-calendar-day"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">H√¥m Nay</div>
                                <div class="stat-value">@ThongKeDonHang.DonHangHomNay</div>
                                <div class="stat-subtitle">@ThongKeDonHang.DoanhThuHomNay.ToString("N0") VNƒê</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact bg-success">
                            <div class="stat-icon"><i class="bi bi-calendar-month"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Th√°ng N√†y</div>
                                <div class="stat-value">@ThongKeDonHang.DonHangThangNay</div>
                                <div class="stat-subtitle">@ThongKeDonHang.DoanhThuThangNay.ToString("N0") VNƒê</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-12 mb-2">
                        <div class="stat-card-compact bg-info">
                            <div class="stat-icon"><i class="bi bi-calendar-year"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">NƒÉm N√†y</div>
                                <div class="stat-value">@ThongKeDonHang.DonHangNamNay</div>
                                <div class="stat-subtitle">@ThongKeDonHang.DoanhThuNamNay.ToString("N0") VNƒê</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Th·ªëng k√™ tr·∫°ng th√°i h√¥m nay - Compact -->
                <div class="row mb-3">
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact status-success">
                            <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">ƒê√£ Thanh To√°n</div>
                                <div class="stat-value">@ThongKeDonHang.DaThanhToanHomNay</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact status-warning">
                            <div class="stat-icon"><i class="bi bi-clock"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Ch·ªù Thanh To√°n</div>
                                <div class="stat-value">@ThongKeDonHang.ChoThanhToanHomNay</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-12 mb-2">
                        <div class="stat-card-compact status-danger">
                            <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">ƒê√£ H·ªßy</div>
                                <div class="stat-value">@ThongKeDonHang.DaHuyHomNay</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter - Compact -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0"><i class="bi bi-funnel"></i> L·ªçc Theo Th·ªùi Gian</h6>
                    </div>
                    <div class="card-body py-3">
                        <EditForm Model="@filterModel" OnValidSubmit="ApplyFilter">
                            <div class="row g-3">
                                <div class="col-md-3">
                                    <label class="form-label">Lo·∫°i L·ªçc</label>
                                    <InputSelect @bind-Value="filterModel.FilterType" class="form-select" @onchange="UpdateFilterFields">
                                        <option value="all">T·∫•t C·∫£</option>
                                        <option value="day">Theo Ng√†y</option>
                                        <option value="month">Theo Th√°ng</option>
                                        <option value="year">Theo NƒÉm</option>
                                    </InputSelect>
                                </div>

                                @if (filterModel.FilterType == "day")
                                {
                                    <div class="col-md-3">
                                        <label class="form-label">Ch·ªçn Ng√†y</label>
                                        <InputDate @bind-Value="filterModel.FilterDate" class="form-control" />
                                    </div>
                                }

                                @if (filterModel.FilterType == "month")
                                {
                                    <div class="col-md-3">
                                        <label class="form-label">Ch·ªçn Th√°ng</label>
                                        <InputSelect @bind-Value="filterModel.FilterMonth" class="form-select">
                                            @for (int month = 1; month <= 12; month++)
                                            {
                                                <option value="@month">Th√°ng @month</option>
                                            }
                                        </InputSelect>
                                    </div>
                                    <div class="col-md-3">
                                        <label class="form-label">Ch·ªçn NƒÉm</label>
                                        <InputSelect @bind-Value="filterModel.FilterYear" class="form-select">
                                            @for (int year = DateTime.Now.Year; year >= DateTime.Now.Year - 5; year--)
                                            {
                                                <option value="@year">@year</option>
                                            }
                                        </InputSelect>
                                    </div>
                                }

                                @if (filterModel.FilterType == "year")
                                {
                                    <div class="col-md-3">
                                        <label class="form-label">Ch·ªçn NƒÉm</label>
                                        <InputSelect @bind-Value="filterModel.FilterYear" class="form-select">
                                            @for (int year = DateTime.Now.Year; year >= DateTime.Now.Year - 5; year--)
                                            {
                                                <option value="@year">@year</option>
                                            }
                                        </InputSelect>
                                    </div>
                                }

                                <div class="col-md-3 d-flex align-items-end">
                                    <button type="submit" class="btn btn-primary me-2">
                                        <i class="bi bi-search"></i> L·ªçc
                                    </button>
                                    <button type="button" class="btn btn-secondary" @onclick="ResetFilter">
                                        <i class="bi bi-x-circle"></i> Reset
                                    </button>
                                </div>
                            </div>
                        </EditForm>

                        @if (FilterType != "all")
                        {
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    K·∫øt qu·∫£ l·ªçc: <strong>@ThongKeDonHang.DonHangFiltered</strong> ƒë∆°n h√†ng
                                    | Doanh thu: <strong>@ThongKeDonHang.DoanhThuFiltered.ToString("N0") VNƒê</strong>
                                </div>
                            </div>
                        }
                    </div>
                </div>

                <!-- Danh s√°ch ƒë∆°n h√†ng -->
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-receipt-cutoff"></i> Danh S√°ch ƒê∆°n H√†ng</h5>
                    </div>
                    <div class="card-body">
                        <DonHangList 
                            DonHangs="DonHangs"
                            KhachHangPageIndex="KhachHangPageIndex"
                            FilterType="FilterType"
                            FilterDate="FilterDate"
                            FilterMonth="FilterMonth"
                            FilterYear="FilterYear"
                            OnPageChange="HandleDonHangPageChange" />
                    </div>
                </div>
            </div>
        }

        <!-- Tab Doanh Thu -->
        @if (ActiveTab == "doanhthu")
        {
            <div class="tab-pane fade show active" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Th·ªëng K√™ Doanh Thu</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="revenue-card">
                                    <div class="revenue-label">Doanh Thu H√¥m Nay</div>
                                    <div class="revenue-value text-primary">@DoanhThuHomNay.ToString("N0") VNƒê</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="revenue-card">
                                    <div class="revenue-label">Doanh Thu Th√°ng N√†y</div>
                                    <div class="revenue-value text-success">@DoanhThuThangNay.ToString("N0") VNƒê</div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="revenue-card revenue-total">
                                    <div class="revenue-label">T·ªïng Doanh Thu</div>
                                    <div class="revenue-value-large text-info">@DoanhThuTong.ToString("N0") VNƒê</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@* Loading indicator *@
@if (IsLoading)
{
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}

<style>
    .statistics-container {
        padding: 20px;
        background-color: #f4f6f9;
        min-height: 100vh;
    }

    .main-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 15px;
    }

    .dashboard-main-title {
        color: #3f4c6b;
        font-weight: 700;
        font-size: 28px;
        margin: 0;
    }

    .dashboard-main-title i {
        color: #ff9800;
        margin-right: 10px;
    }

    /* Stat Cards */
    .stat-card {
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    /* Compact Stat Cards */
    .stat-card-compact {
        border-radius: 8px;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
    }

    .stat-card-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-card-compact .stat-icon {
        font-size: 24px;
        opacity: 0.9;
        flex-shrink: 0;
    }

    .stat-card-compact .stat-content {
        flex: 1;
        min-width: 0;
    }

    .stat-card-compact .stat-label {
        font-size: 11px;
        opacity: 0.9;
        margin-bottom: 4px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card-compact .stat-value {
        font-size: 20px;
        font-weight: 700;
        line-height: 1.2;
    }

    .stat-card-compact .stat-value-small {
        font-size: 14px;
        font-weight: 600;
        line-height: 1.2;
    }

    .stat-card-compact .stat-value-large {
        font-size: 18px;
        font-weight: 700;
        line-height: 1.2;
    }

    .stat-card-compact .stat-subtitle {
        font-size: 11px;
        opacity: 0.85;
        margin-top: 2px;
        font-weight: 500;
    }

    .stat-card-compact.status-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-card-compact.status-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card-compact.status-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card-header {
        padding: 15px 20px;
        font-size: 14px;
        font-weight: 600;
        background-color: rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-card-body {
        padding: 25px 20px;
        font-size: 32px;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card-body-small {
        padding: 20px;
        font-size: 24px;
        font-weight: 700;
        line-height: 1.3;
    }

    .stat-card-subtitle {
        font-size: 16px;
        font-weight: 500;
        opacity: 0.9;
        margin-top: 8px;
    }

    .stat-card-body-large {
        padding: 35px 20px;
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
        text-align: center;
    }

    /* Status Stat Cards */
    .status-stat-card {
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .status-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .status-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .status-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }

    .status-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .status-value {
        font-size: 36px;
        font-weight: 700;
    }

    .bg-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
    .bg-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important; }
    .bg-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; }
    .bg-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important; }
    .bg-gradient { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important; }

    /* Tabs */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
    }

    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: #ff9800;
        color: #ff9800;
    }

    .nav-tabs .nav-link.active {
        color: #ff9800;
        background-color: transparent;
        border-bottom-color: #ff9800;
    }

    /* Age Statistics */
    .age-stat-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .age-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
    }

    .age-value {
        font-size: 24px;
        font-weight: 700;
        color: #3f4c6b;
    }

    /* Revenue Cards */
    .revenue-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .revenue-card.revenue-total {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .revenue-label {
        font-size: 16px;
        color: #6c757d;
        margin-bottom: 10px;
    }

    .revenue-card.revenue-total .revenue-label {
        color: rgba(255, 255, 255, 0.9);
    }

    .revenue-value {
        font-size: 28px;
        font-weight: 700;
    }

    .revenue-value-large {
        font-size: 40px;
        font-weight: 700;
        color: white !important;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
</style>

@code {
    private const int PAGE_SIZE = 5;
    private const string KHACH_HANG_ROLE = "KhachHang";

    // T·ªïng quan th·ªëng k√™
    private int TongKhachHang { get; set; }
    private int TongDonHang { get; set; }
    private decimal DoanhThuHomNay { get; set; }
    private decimal DoanhThuThangNay { get; set; }
    private decimal DoanhThuTong { get; set; }

    // Th·ªëng k√™ kh√°ch h√†ng theo ƒë·ªô tu·ªïi
    private Dictionary<string, int> ThongKeTheoDoTuoi { get; set; } = new();

    // Danh s√°ch kh√°ch h√†ng (ph√¢n trang)
    private PaginatedList<NguoiDungVM>? KhachHangs { get; set; }
    private int KhachHangPageIndex { get; set; } = 1;

    // Danh s√°ch ƒë∆°n h√†ng (ph√¢n trang)
    private PaginatedList<DonHangVM>? DonHangs { get; set; }
    private int DonHangPageIndex { get; set; } = 1;

    // Th·ªëng k√™ ƒë∆°n h√†ng theo th·ªùi gian
    private ThongKeDonHangViewModel ThongKeDonHang { get; set; } = new();

    // Filter th·ªùi gian
    private string FilterType { get; set; } = "all";
    private DateTime? FilterDate { get; set; }
    private int? FilterMonth { get; set; }
    private int? FilterYear { get; set; }

    // UI State
    private string ActiveTab { get; set; } = "khachhang";
    private string ErrorMessage { get; set; } = string.Empty;
    private bool HasError => !string.IsNullOrEmpty(ErrorMessage);
    private bool IsLoading { get; set; } = false;

    // Filter Model
    private FilterModel filterModel = new();

    private bool _isFirstLoad = true;
    private string _lastUrl = string.Empty;
    private bool _isHandlingPagination = false; // Flag to prevent OnParametersSetAsync from reloading during pagination

    protected override Task OnInitializedAsync()
    {
        // Blazor lifecycle method - load data (no JS calls here during prerendering)
        // Don't load here, wait for OnParametersSetAsync to avoid double loading
        return Task.CompletedTask;
    }

    protected override async Task OnParametersSetAsync()
    {
        // Skip if we're currently handling pagination to prevent reload loop
        if (_isHandlingPagination)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚è≠Ô∏è OnParametersSetAsync: Skipping because _isHandlingPagination = true");
            }
            catch { }
            return;
        }
        
        // Read query parameters from URL
        var uri = new Uri(Navigation.Uri);
        var currentUrl = uri.PathAndQuery + uri.Fragment;
        
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", 
                $"üìã OnParametersSetAsync called - currentUrl: {currentUrl}, _lastUrl: {_lastUrl}");
        }
        catch { }
        
        // Skip reload if URL hasn't changed (prevents reload when using history.pushState)
        if (currentUrl == _lastUrl)
        {
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚è≠Ô∏è OnParametersSetAsync: URL unchanged, skipping reload");
            }
            catch { }
            _lastUrl = currentUrl;
            return;
        }
        
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", 
                $"üîÑ OnParametersSetAsync: URL changed, reloading data");
        }
        catch { }
        
        var query = QueryHelpers.ParseQuery(uri.Query);
        
        // Parse page indices
        if (query.TryGetValue("khachHangPage", out var khachHangPageValue) && 
            int.TryParse(khachHangPageValue, out int khachHangPage) && khachHangPage > 0)
        {
            KhachHangPageIndex = khachHangPage;
        }
        
        if (query.TryGetValue("donHangPage", out var donHangPageValue) && 
            int.TryParse(donHangPageValue, out int donHangPage) && donHangPage > 0)
        {
            DonHangPageIndex = donHangPage;
        }
        
        // Validate page indices after loading - will be adjusted in LoadDataAsync if needed
        
        // Parse filter parameters
        if (query.TryGetValue("filterType", out var filterTypeValue))
        {
            FilterType = filterTypeValue.ToString();
        }
        else
        {
            FilterType = "all";
        }
        
        if (query.TryGetValue("filterDate", out var filterDateValue) && 
            DateTime.TryParse(filterDateValue, out DateTime filterDate))
        {
            FilterDate = filterDate;
        }
        else
        {
            FilterDate = null;
        }
        
        if (query.TryGetValue("filterMonth", out var filterMonthValue) && 
            int.TryParse(filterMonthValue, out int filterMonth) && filterMonth >= 1 && filterMonth <= 12)
        {
            FilterMonth = filterMonth;
        }
        else
        {
            FilterMonth = null;
        }
        
        if (query.TryGetValue("filterYear", out var filterYearValue) && 
            int.TryParse(filterYearValue, out int filterYear) && filterYear > 0)
        {
            FilterYear = filterYear;
        }
        else
        {
            FilterYear = null;
        }
        
        // Parse hash for active tab
        var hash = uri.Fragment;
        if (hash == "#khachhang")
        {
            ActiveTab = "khachhang";
        }
        else if (hash == "#donhang")
        {
            ActiveTab = "donhang";
        }
        else if (hash == "#doanhthu")
        {
            ActiveTab = "doanhthu";
        }
        
        _lastUrl = currentUrl;
        await LoadDataAsync();
    }

    private async Task UpdateUrlAsync(int? khachHangPage = null, int? donHangPage = null, string? hash = null, bool preserveOtherPage = true)
    {
        var queryParams = new Dictionary<string, string?>();
        
        // Only update the page that was explicitly provided, preserve the other one
        if (khachHangPage.HasValue)
        {
            queryParams["khachHangPage"] = khachHangPage.Value.ToString();
            if (preserveOtherPage)
            {
                queryParams["donHangPage"] = DonHangPageIndex.ToString();
            }
        }
        else if (donHangPage.HasValue)
        {
            queryParams["donHangPage"] = donHangPage.Value.ToString();
            if (preserveOtherPage)
            {
                queryParams["khachHangPage"] = KhachHangPageIndex.ToString();
            }
        }
        else
        {
            // If neither is provided, use current values
            queryParams["khachHangPage"] = KhachHangPageIndex.ToString();
            queryParams["donHangPage"] = DonHangPageIndex.ToString();
        }

        if (FilterType != "all")
        {
            queryParams["filterType"] = FilterType;
            if (FilterDate.HasValue)
            {
                queryParams["filterDate"] = FilterDate.Value.ToString("yyyy-MM-dd");
            }
            if (FilterMonth.HasValue)
            {
                queryParams["filterMonth"] = FilterMonth.Value.ToString();
            }
            if (FilterYear.HasValue)
            {
                queryParams["filterYear"] = FilterYear.Value.ToString();
            }
        }

        var newUrl = QueryHelpers.AddQueryString("/Admin/Statistics", queryParams);
        if (!string.IsNullOrEmpty(hash))
        {
            newUrl += hash;
        }
        
        // Use JavaScript to update URL without triggering navigation
        try
        {
            await JSRuntime.InvokeVoidAsync("window.history.pushState", null, "", newUrl);
            
            // Parse newUrl to match format used in OnParametersSetAsync (PathAndQuery + Fragment)
            var uri = new Uri(Navigation.BaseUri + newUrl.TrimStart('/'));
            _lastUrl = uri.PathAndQuery + uri.Fragment;
            
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"üîó UpdateUrlAsync: Set URL to {newUrl}, _lastUrl = {_lastUrl}");
            }
            catch { }
        }
        catch
        {
            // Fallback to Navigation.NavigateTo if JS fails
            Navigation.NavigateTo(newUrl, forceLoad: false);
        }
    }

    private async Task HandleKhachHangPageChange(int page)
    {
        // Set flag to prevent OnParametersSetAsync from reloading
        _isHandlingPagination = true;
        
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", 
                $"üü¢ HandleKhachHangPageChange START - page: {page}, _isHandlingPagination: {_isHandlingPagination}");
            
            IsLoading = true;
            ErrorMessage = string.Empty;
            
            // Validate page number - must be at least 1
            if (page < 1)
            {
                page = 1;
            }
            
            KhachHangPageIndex = page;
            
            await JSRuntime.InvokeVoidAsync("console.log", $"üîÑ Loading khachhang page {page}...");
            
            // CH·ªà load danh s√°ch kh√°ch h√†ng, KH√îNG load ƒë∆°n h√†ng
            await LoadDanhSachKhachHang(page);
            
            if (KhachHangs != null)
            {
                // Validate page against TotalPages - if page > TotalPages, redirect to last page
                if (KhachHangs.TotalPages > 0 && page > KhachHangs.TotalPages)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"‚ö†Ô∏è Page {page} exceeds TotalPages {KhachHangs.TotalPages}, redirecting to page {KhachHangs.TotalPages}");
                    page = KhachHangs.TotalPages;
                    KhachHangPageIndex = page;
                    await LoadDanhSachKhachHang(page);
                }
                
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚úÖ Loaded khachhang page {page}: {KhachHangs.Count} items, Total: {KhachHangs.TotalCount}, TotalPages: {KhachHangs.TotalPages}");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"‚ùå KhachHangs is null after loading page {page}");
            }
            
            // Update URL and _lastUrl BEFORE OnParametersSetAsync can be triggered
            // Only update khachHangPage, preserve donHangPage
            await UpdateUrlAsync(khachHangPage: page, hash: "#khachhang", preserveOtherPage: true);
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"L·ªói khi t·∫£i trang {page}: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("console.error", $"‚ùå Error loading khachhang page {page}:", ex.Message);
            StateHasChanged();
        }
        finally
        {
            IsLoading = false;
            // Reset flag after a short delay to allow OnParametersSetAsync to process next time
            await Task.Delay(100);
            _isHandlingPagination = false;
        }
    }

    private async Task HandleDonHangPageChange(int page)
    {
        // Set flag to prevent OnParametersSetAsync from reloading
        _isHandlingPagination = true;
        
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", 
                $"üü† HandleDonHangPageChange START - page: {page}, _isHandlingPagination: {_isHandlingPagination}");
            
            IsLoading = true;
            ErrorMessage = string.Empty;
            
            // Validate page number - must be at least 1
            if (page < 1)
            {
                page = 1;
            }
            
            DonHangPageIndex = page;
            
            await JSRuntime.InvokeVoidAsync("console.log", $"üîÑ Loading donhang page {page}...");
            
            // CH·ªà load danh s√°ch ƒë∆°n h√†ng, KH√îNG load kh√°ch h√†ng
            await LoadDanhSachDonHang(page);
            
            if (DonHangs != null)
            {
                // Validate page against TotalPages - if page > TotalPages, redirect to last page
                if (DonHangs.TotalPages > 0 && page > DonHangs.TotalPages)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"‚ö†Ô∏è Page {page} exceeds TotalPages {DonHangs.TotalPages}, redirecting to page {DonHangs.TotalPages}");
                    page = DonHangs.TotalPages;
                    DonHangPageIndex = page;
                    await LoadDanhSachDonHang(page);
                }
                
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚úÖ Loaded donhang page {page}: {DonHangs.Count} items, Total: {DonHangs.TotalCount}, TotalPages: {DonHangs.TotalPages}");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"‚ùå DonHangs is null after loading page {page}");
            }
            
            // Update URL and _lastUrl BEFORE OnParametersSetAsync can be triggered
            // Only update donHangPage, preserve khachHangPage
            await UpdateUrlAsync(donHangPage: page, hash: "#donhang", preserveOtherPage: true);
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"L·ªói khi t·∫£i trang {page}: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("console.error", $"‚ùå Error loading donhang page {page}:", ex.Message);
            StateHasChanged();
        }
        finally
        {
            IsLoading = false;
            // Reset flag after a short delay to allow OnParametersSetAsync to process next time
            await Task.Delay(100);
            _isHandlingPagination = false;
        }
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // JS interop can only be called in OnAfterRenderAsync when prerendering is enabled
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", "‚úÖ Blazor Statistics Page Loaded");
                await JSRuntime.InvokeVoidAsync("console.log", "üöÄ Blazor OnInitializedAsync called");
                await JSRuntime.InvokeVoidAsync("console.log", "‚ú® Blazor Component Rendered Successfully");
                
                // Try to check for Blazor SignalR connection
                try
                {
                    var isConnected = await JSRuntime.InvokeAsync<bool>("eval", 
                        "window.Blazor && typeof window.Blazor.start === 'function'");
                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"üîó Blazor Hub Connection Status: {(isConnected ? "Connected" : "Checking...")}");
                }
                catch
                {
                    // Ignore if check fails
                }
            }
            catch
            {
                // Ignore JS errors during prerendering
            }
        }
    }

    private async Task LoadDataAsync()
    {
        // Don't set IsLoading here if already set by caller (SetActiveTab, etc.)
        if (!IsLoading)
        {
            IsLoading = true;
        }
        ErrorMessage = string.Empty;

        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", $"üì• LoadDataAsync called for ActiveTab: {ActiveTab}");
            
            // Load t·ªïng quan lu√¥n v√¨ hi·ªÉn th·ªã ·ªü tr√™n c√πng
            await LoadTongQuanThongKe();
            
            // Load data theo tab ƒëang active (ch·∫°y tu·∫ßn t·ª± v√¨ DbContext kh√¥ng thread-safe)
            if (ActiveTab == "khachhang")
            {
                await JSRuntime.InvokeVoidAsync("console.log", "üìã Loading khachhang data...");
                await LoadThongKeKhachHangTheoDoTuoi();
                await LoadDanhSachKhachHang(KhachHangPageIndex);
                
                // Validate and adjust page index if needed
                if (KhachHangs != null && KhachHangs.TotalPages > 0 && KhachHangPageIndex > KhachHangs.TotalPages)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"‚ö†Ô∏è KhachHangPageIndex {KhachHangPageIndex} > TotalPages {KhachHangs.TotalPages}, adjusting to {KhachHangs.TotalPages}");
                    KhachHangPageIndex = KhachHangs.TotalPages;
                    await LoadDanhSachKhachHang(KhachHangPageIndex);
                }
            }
            else if (ActiveTab == "donhang")
            {
                await JSRuntime.InvokeVoidAsync("console.log", "üì¶ Loading donhang data...");
                await LoadThongKeDonHang();
                await LoadDanhSachDonHang(DonHangPageIndex);
                
                // Validate and adjust page index if needed
                if (DonHangs != null && DonHangs.TotalPages > 0 && DonHangPageIndex > DonHangs.TotalPages)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"‚ö†Ô∏è DonHangPageIndex {DonHangPageIndex} > TotalPages {DonHangs.TotalPages}, adjusting to {DonHangs.TotalPages}");
                    DonHangPageIndex = DonHangs.TotalPages;
                    await LoadDanhSachDonHang(DonHangPageIndex);
                }
            }
            else if (ActiveTab == "doanhthu")
            {
                await JSRuntime.InvokeVoidAsync("console.log", "üí∞ Loading doanhthu data...");
                await LoadThongKeDonHang();
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.log", "üìö Loading all data (default)...");
                // Default tab (khachhang) - load t·∫•t c·∫£
                await LoadThongKeKhachHangTheoDoTuoi();
                await LoadThongKeDonHang();
                await LoadDanhSachKhachHang(KhachHangPageIndex);
                
                // Validate and adjust page indices if needed
                if (KhachHangs != null && KhachHangs.TotalPages > 0 && KhachHangPageIndex > KhachHangs.TotalPages)
                {
                    KhachHangPageIndex = KhachHangs.TotalPages;
                    await LoadDanhSachKhachHang(KhachHangPageIndex);
                }
                
                await LoadDanhSachDonHang(DonHangPageIndex);
                
                if (DonHangs != null && DonHangs.TotalPages > 0 && DonHangPageIndex > DonHangs.TotalPages)
                {
                    DonHangPageIndex = DonHangs.TotalPages;
                    await LoadDanhSachDonHang(DonHangPageIndex);
                }
            }
        }
        catch (DbUpdateException ex)
        {
            HandleDatabaseError(ex);
        }
        catch (SqlException ex)
        {
            HandleSqlError(ex);
        }
        catch (Exception ex)
        {
            ErrorMessage = $"L·ªói kh√¥ng x√°c ƒë·ªãnh: {ex.Message}";
        }
        finally
        {
            IsLoading = false;
        }
    }

    private async Task LoadTongQuanThongKe()
    {
        try
        {
            var khachHangRoleId = await Context.VaiTro
                .Where(r => r.TenVaiTro == KHACH_HANG_ROLE)
                .Select(r => r.RoleId)
                .FirstOrDefaultAsync();

            if (khachHangRoleId != null)
            {
                TongKhachHang = await Context.UserRole
                    .Where(ur => ur.RoleId == khachHangRoleId)
                    .CountAsync();
            }

            TongDonHang = await Context.DonHang.CountAsync();

            var today = DateTime.Today;
            DoanhThuHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var firstDayOfMonth = new DateTime(today.Year, today.Month, 1);
            DoanhThuThangNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfMonth && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            DoanhThuTong = await Context.DonHang
                .Where(d => d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n")
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;
        }
        catch (Exception ex)
        {
            throw new Exception($"L·ªói khi t·∫£i t·ªïng quan th·ªëng k√™: {ex.Message}", ex);
        }
    }

    private async Task LoadThongKeKhachHangTheoDoTuoi()
    {
        try
        {
            var khachHangRoleId = await Context.VaiTro
                .Where(r => r.TenVaiTro == KHACH_HANG_ROLE)
                .Select(r => r.RoleId)
                .FirstOrDefaultAsync();

            if (khachHangRoleId == null) return;

            var now = DateTime.Now;
            var currentYear = now.Year;
            var currentDayOfYear = now.DayOfYear;

            // T√≠nh to√°n tu·ªïi tr·ª±c ti·∫øp trong database query ƒë·ªÉ t·ªëi ∆∞u performance
            var ageGroups = await Context.UserRole
                .Where(ur => ur.RoleId == khachHangRoleId)
                .Join(Context.NguoiDung,
                    ur => ur.UserId,
                    nd => nd.UserId,
                    (ur, nd) => nd)
                .Where(nd => nd.NgaySinh != null)
                .Select(nd => new
                {
                    BirthYear = nd.NgaySinh.Value.Year,
                    BirthDayOfYear = nd.NgaySinh.Value.DayOfYear
                })
                .ToListAsync();

            ThongKeTheoDoTuoi = new Dictionary<string, int>
            {
                { "D∆∞·ªõi 18 tu·ªïi", 0 },
                { "18-25 tu·ªïi", 0 },
                { "26-35 tu·ªïi", 0 },
                { "36-45 tu·ªïi", 0 },
                { "46-60 tu·ªïi", 0 },
                { "Tr√™n 60 tu·ªïi", 0 }
            };

            foreach (var kh in ageGroups)
            {
                var tuoi = currentYear - kh.BirthYear;
                if (kh.BirthDayOfYear > currentDayOfYear) tuoi--;

                if (tuoi < 18)
                    ThongKeTheoDoTuoi["D∆∞·ªõi 18 tu·ªïi"]++;
                else if (tuoi <= 25)
                    ThongKeTheoDoTuoi["18-25 tu·ªïi"]++;
                else if (tuoi <= 35)
                    ThongKeTheoDoTuoi["26-35 tu·ªïi"]++;
                else if (tuoi <= 45)
                    ThongKeTheoDoTuoi["36-45 tu·ªïi"]++;
                else if (tuoi <= 60)
                    ThongKeTheoDoTuoi["46-60 tu·ªïi"]++;
                else
                    ThongKeTheoDoTuoi["Tr√™n 60 tu·ªïi"]++;
            }
        }
        catch (Exception ex)
        {
            throw new Exception($"L·ªói khi th·ªëng k√™ theo ƒë·ªô tu·ªïi: {ex.Message}", ex);
        }
    }

    private async Task LoadDanhSachKhachHang(int pageIndex)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", $"üì• LoadDanhSachKhachHang called with pageIndex: {pageIndex}");
            
            var khachHangRoleId = await Context.VaiTro
                .Where(r => r.TenVaiTro == KHACH_HANG_ROLE)
                .Select(r => r.RoleId)
                .FirstOrDefaultAsync();

            if (khachHangRoleId == null)
            {
                KhachHangs = PaginatedList<NguoiDungViewModel>.Empty(pageIndex, PAGE_SIZE);
                await JSRuntime.InvokeVoidAsync("console.log", $"‚ö†Ô∏è khachHangRoleId is null, returning empty list");
                return;
            }

            var query = Context.UserRole
                .Where(ur => ur.RoleId == khachHangRoleId)
                .Join(Context.NguoiDung,
                    ur => ur.UserId,
                    nd => nd.UserId,
                    (ur, nd) => nd)
                .Select(nd => new NguoiDungVM
                {
                    UserId = nd.UserId,
                    HoTen = nd.HoTen,
                    Email = nd.Email,
                    SoDienThoai = nd.SoDienThoai ?? "‚Äî",
                    NgaySinh = nd.NgaySinh,
                    Tuoi = nd.NgaySinh != null ?
                        DateTime.Now.Year - nd.NgaySinh.Value.Year -
                        (DateTime.Now.DayOfYear < nd.NgaySinh.Value.DayOfYear ? 1 : 0) : (int?)null,
                    TrangThai = nd.TrangThai
                })
                .OrderBy(nd => nd.HoTen);

            KhachHangs = await PaginationService.CreatePagedListAsync(query, pageIndex, PAGE_SIZE);
            
            if (KhachHangs != null)
            {
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚úÖ LoadDanhSachKhachHang result: requested page {pageIndex}, got page {KhachHangs.PageIndex}, Total: {KhachHangs.TotalCount}, TotalPages: {KhachHangs.TotalPages}, Count: {KhachHangs.Count}");
                
                // If PageIndex differs from requested pageIndex, update it
                if (KhachHangs.PageIndex != pageIndex)
                {
                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"‚ö†Ô∏è PageIndex mismatch: requested {pageIndex}, got {KhachHangs.PageIndex}");
                }
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.log", $"‚ùå LoadDanhSachKhachHang returned null");
            }
        }
        catch (Exception ex)
        {
            await JSRuntime.InvokeVoidAsync("console.error", $"‚ùå Error in LoadDanhSachKhachHang:", ex.Message);
            throw new Exception($"L·ªói khi t·∫£i danh s√°ch kh√°ch h√†ng: {ex.Message}", ex);
        }
    }

    private async Task LoadThongKeDonHang()
    {
        try
        {
            var today = DateTime.Today;
            var firstDayOfMonth = new DateTime(today.Year, today.Month, 1);
            var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
            var firstDayOfYear = new DateTime(today.Year, 1, 1);
            var lastDayOfYear = new DateTime(today.Year, 12, 31);

            // Th·ªëng k√™ theo filter (c·∫ßn build query tr∆∞·ªõc)
            var filteredQuery = Context.DonHang.AsQueryable();

            if (FilterType == "day" && FilterDate.HasValue)
            {
                filteredQuery = filteredQuery.Where(d => d.NgayDat.Date == FilterDate.Value.Date);
            }
            else if (FilterType == "month" && FilterMonth.HasValue && FilterYear.HasValue)
            {
                var startOfMonth = new DateTime(FilterYear.Value, FilterMonth.Value, 1);
                var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);
                filteredQuery = filteredQuery.Where(d => d.NgayDat >= startOfMonth && d.NgayDat <= endOfMonth);
            }
            else if (FilterType == "year" && FilterYear.HasValue)
            {
                var startOfYear = new DateTime(FilterYear.Value, 1, 1);
                var endOfYear = new DateTime(FilterYear.Value, 12, 31);
                filteredQuery = filteredQuery.Where(d => d.NgayDat >= startOfYear && d.NgayDat <= endOfYear);
            }

            // Ch·∫°y c√°c query tu·∫ßn t·ª± v√¨ DbContext kh√¥ng thread-safe
            var donHangHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today)
                .CountAsync();

            var doanhThuHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var donHangThangNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfMonth && d.NgayDat <= lastDayOfMonth)
                .CountAsync();

            var doanhThuThangNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfMonth && d.NgayDat <= lastDayOfMonth && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var donHangNamNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfYear && d.NgayDat <= lastDayOfYear)
                .CountAsync();

            var doanhThuNamNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfYear && d.NgayDat <= lastDayOfYear && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var donHangFiltered = await filteredQuery.CountAsync();
            var doanhThuFiltered = await filteredQuery
                .Where(d => d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n")
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var daThanhToanHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .CountAsync();

            var choThanhToanHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && d.TrangThaiThanhToan == "DangChoThanhToan")
                .CountAsync();

            var daHuyHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da huy" || d.TrangThaiThanhToan == "ƒê√£ h·ªßy"))
                .CountAsync();

            ThongKeDonHang = new ThongKeDonHangViewModel
            {
                DonHangHomNay = donHangHomNay,
                DoanhThuHomNay = doanhThuHomNay,
                DonHangThangNay = donHangThangNay,
                DoanhThuThangNay = doanhThuThangNay,
                DonHangNamNay = donHangNamNay,
                DoanhThuNamNay = doanhThuNamNay,
                DonHangFiltered = donHangFiltered,
                DoanhThuFiltered = doanhThuFiltered,
                DaThanhToanHomNay = daThanhToanHomNay,
                ChoThanhToanHomNay = choThanhToanHomNay,
                DaHuyHomNay = daHuyHomNay
            };
        }
        catch (Exception ex)
        {
            throw new Exception($"L·ªói khi th·ªëng k√™ ƒë∆°n h√†ng: {ex.Message}", ex);
        }
    }

    private async Task LoadDanhSachDonHang(int pageIndex)
    {
        try
        {
            var query = Context.DonHang
                .Include(d => d.nguoiDung)
                .Include(d => d.ChuyenXe)
                .AsQueryable();

            // √Åp d·ª•ng filter
            if (FilterType == "day" && FilterDate.HasValue)
            {
                query = query.Where(d => d.NgayDat.Date == FilterDate.Value.Date);
            }
            else if (FilterType == "month" && FilterMonth.HasValue && FilterYear.HasValue)
            {
                var startOfMonth = new DateTime(FilterYear.Value, FilterMonth.Value, 1);
                var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);
                query = query.Where(d => d.NgayDat >= startOfMonth && d.NgayDat <= endOfMonth);
            }
            else if (FilterType == "year" && FilterYear.HasValue)
            {
                var startOfYear = new DateTime(FilterYear.Value, 1, 1);
                var endOfYear = new DateTime(FilterYear.Value, 12, 31);
                query = query.Where(d => d.NgayDat >= startOfYear && d.NgayDat <= endOfYear);
            }

            var donHangQuery = query
                .Select(d => new DonHangVM
                {
                    DonHangId = d.DonHangId,
                    KhachHangId = d.IDKhachHang,
                    KhachHangTen = d.nguoiDung.HoTen,
                    ChuyenId = d.ChuyenId,
                    NgayDat = d.NgayDat,
                    TongTien = d.TongTien,
                    TrangThaiThanhToan = d.TrangThaiThanhToan,
                    ThoiGianHetHan = d.ThoiGianHetHan
                })
                .OrderByDescending(d => d.NgayDat);

            DonHangs = await PaginationService.CreatePagedListAsync(donHangQuery, pageIndex, PAGE_SIZE);
        }
        catch (Exception ex)
        {
            throw new Exception($"L·ªói khi t·∫£i danh s√°ch ƒë∆°n h√†ng: {ex.Message}", ex);
        }
    }

    private void HandleDatabaseError(DbUpdateException ex)
    {
        if (ex.InnerException is SqlException sqlEx)
        {
            HandleSqlError(sqlEx);
        }
        else
        {
            ErrorMessage = $"L·ªói c·∫≠p nh·∫≠t c∆° s·ªü d·ªØ li·ªáu: {ex.Message}";
        }
    }

    private void HandleSqlError(SqlException ex)
    {
        switch (ex.Number)
        {
            case 547:
                ErrorMessage = "Kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c n√†y do vi ph·∫°m r√†ng bu·ªôc kh√≥a ngo·∫°i. Vui l√≤ng ki·ªÉm tra d·ªØ li·ªáu li√™n quan.";
                break;
            case 2627:
            case 2601:
                ErrorMessage = "L·ªói kh√≥a ch√≠nh: D·ªØ li·ªáu ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng.";
                break;
            case 2:
                ErrorMessage = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.";
                break;
            default:
                ErrorMessage = $"L·ªói SQL (M√£: {ex.Number}): {ex.Message}";
                break;
        }
    }

    private async Task SetActiveTab(string tab)
    {
        if (ActiveTab == tab)
        {
            await JSRuntime.InvokeVoidAsync("console.log", $"‚è≠Ô∏è Tab {tab} already active, skipping reload");
            return; // Already on this tab, no need to reload
        }
            
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", $"üîÑ Switching to tab: {tab} (from {ActiveTab})");
            IsLoading = true;
            ErrorMessage = string.Empty;
            
            // Set ActiveTab BEFORE loading data
            ActiveTab = tab;
            await JSRuntime.InvokeVoidAsync("console.log", $"‚úÖ ActiveTab set to: {ActiveTab}");
            
            // Update URL hash
            await UpdateUrlAsync(hash: $"#{tab}");
            
            // Reload data for the active tab
            await JSRuntime.InvokeVoidAsync("console.log", $"üìä Loading data for tab: {ActiveTab}");
            await LoadDataAsync();
            
            // Verify data was loaded
            if (ActiveTab == "khachhang" && KhachHangs != null)
            {
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚úÖ KhachHangs loaded: {KhachHangs.Count} items, Total: {KhachHangs.TotalCount}");
            }
            else if (ActiveTab == "donhang" && DonHangs != null)
            {
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚úÖ DonHangs loaded: {DonHangs.Count} items, Total: {DonHangs.TotalCount}");
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("console.log", 
                    $"‚ö†Ô∏è Data not loaded for tab: {ActiveTab}");
            }
            
            // Update _lastUrl after loading to prevent OnParametersSetAsync from reloading
            var uri = new Uri(Navigation.Uri);
            _lastUrl = uri.PathAndQuery + uri.Fragment;
            await JSRuntime.InvokeVoidAsync("console.log", $"üîó URL updated: {_lastUrl}");
            
            StateHasChanged();
        }
        catch (Exception ex)
        {
            ErrorMessage = $"L·ªói khi chuy·ªÉn tab: {ex.Message}";
            await JSRuntime.InvokeVoidAsync("console.error", $"‚ùå Error switching tab:", ex.Message);
            StateHasChanged();
        }
        finally
        {
            IsLoading = false;
        }
    }

    private void UpdateFilterFields()
    {
        // This will be handled by the conditional rendering
        StateHasChanged();
    }

    private async Task ApplyFilter()
    {
        FilterType = filterModel.FilterType;
        FilterDate = filterModel.FilterDate;
        FilterMonth = filterModel.FilterMonth;
        FilterYear = filterModel.FilterYear ?? DateTime.Now.Year;
        DonHangPageIndex = 1;

        await LoadThongKeDonHang();
        await LoadDanhSachDonHang(DonHangPageIndex);
        ActiveTab = "donhang";
    }

    private async Task ResetFilter()
    {
        FilterType = "all";
        FilterDate = null;
        FilterMonth = null;
        FilterYear = DateTime.Now.Year;
        DonHangPageIndex = 1;

        filterModel = new FilterModel { FilterType = "all", FilterYear = DateTime.Now.Year };

        await LoadThongKeDonHang();
        await LoadDanhSachDonHang(DonHangPageIndex);
    }

    public void Dispose()
    {
        // Cleanup if needed
    }

    public class ThongKeDonHangViewModel
    {
        public int DonHangHomNay { get; set; }
        public decimal DoanhThuHomNay { get; set; }
        public int DonHangThangNay { get; set; }
        public decimal DoanhThuThangNay { get; set; }
        public int DonHangNamNay { get; set; }
        public decimal DoanhThuNamNay { get; set; }
        public int DonHangFiltered { get; set; }
        public decimal DoanhThuFiltered { get; set; }
        public int DaThanhToanHomNay { get; set; }
        public int ChoThanhToanHomNay { get; set; }
        public int DaHuyHomNay { get; set; }
    }

    public class FilterModel
    {
        public string FilterType { get; set; } = "all";
        public DateTime? FilterDate { get; set; }
        public int? FilterMonth { get; set; }
        public int? FilterYear { get; set; } = DateTime.Now.Year;
    }
}


