@page "/Statistics"
@page "/Admin/Statistics"
@using AdminDashboard.Models
@using AdminDashboard.Services
@using AdminDashboard.TransportDBContext
@using AdminDashboard.Areas.Admin.Components
@using Microsoft.AspNetCore.Authorization
@using Microsoft.AspNetCore.WebUtilities
@using Microsoft.EntityFrameworkCore
@using Microsoft.Data.SqlClient
@using DonHangVM = AdminDashboard.Areas.Admin.Components.DonHangViewModel
@using NguoiDungVM = AdminDashboard.Areas.Admin.Components.NguoiDungViewModel
@attribute [Authorize(Roles = "Admin")]
@inject Db27524Context Context
@inject IPaginationService PaginationService
@inject IJSRuntime JSRuntime
@inject NavigationManager Navigation
@implements IDisposable

<div class="statistics-container">
    <!-- Error Alert -->
    @if (HasError)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            <i class="bi bi-exclamation-triangle-fill me-2"></i>
            <strong>L·ªói!</strong> @ErrorMessage
            <button type="button" class="btn-close" @onclick="() => ErrorMessage = string.Empty"></button>
        </div>
    }

    <!-- Header -->
    <div class="main-title-container mb-4">
        <h2 class="dashboard-main-title">
            <i class="bi bi-bar-chart-line-fill"></i> üìä Th·ªëng K√™ H·ªá Th·ªëng
        </h2>
    </div>

    <!-- T·ªïng Quan Th·ªëng K√™ - Compact Layout -->
    <div class="row mb-3">
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-primary">
                <div class="stat-icon"><i class="bi bi-people-fill"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Kh√°ch H√†ng</div>
                    <div class="stat-value">@TongKhachHang</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-success">
                <div class="stat-icon"><i class="bi bi-receipt"></i></div>
                <div class="stat-content">
                    <div class="stat-label">ƒê∆°n H√†ng</div>
                    <div class="stat-value">@TongDonHang</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-warning">
                <div class="stat-icon"><i class="bi bi-calendar-day"></i></div>
                <div class="stat-content">
                    <div class="stat-label">H√¥m Nay</div>
                    <div class="stat-value-small">@DoanhThuHomNay.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-lg-2 col-md-4 col-sm-6 mb-2">
            <div class="stat-card-compact bg-info">
                <div class="stat-icon"><i class="bi bi-calendar-month"></i></div>
                <div class="stat-content">
                    <div class="stat-label">Th√°ng N√†y</div>
                    <div class="stat-value-small">@DoanhThuThangNay.ToString("N0")</div>
                </div>
            </div>
        </div>
        <div class="col-lg-4 col-md-8 col-sm-12 mb-2">
            <div class="stat-card-compact bg-gradient">
                <div class="stat-icon"><i class="bi bi-cash-coin"></i></div>
                <div class="stat-content">
                    <div class="stat-label">T·ªïng Doanh Thu</div>
                    <div class="stat-value-large">@DoanhThuTong.ToString("N0") VNƒê</div>
                </div>
            </div>
        </div>
    </div>


    <!-- Tab Content -->
    <div class="tab-content">
        <!-- Tab Kh√°ch H√†ng -->
        @if (ActiveTab == "khachhang")
        {
            <div class="tab-pane fade show active" role="tabpanel">
                <!-- Th·ªëng k√™ theo ƒë·ªô tu·ªïi -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="bi bi-pie-chart"></i> Th·ªëng K√™ Kh√°ch H√†ng Theo ƒê·ªô Tu·ªïi</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            @foreach (var item in ThongKeTheoDoTuoi)
                            {
                                <div class="col-md-4 col-sm-6 mb-3">
                                    <div class="age-stat-item">
                                        <div class="age-label">@item.Key</div>
                                        <div class="age-value">@item.Value <small>kh√°ch h√†ng</small></div>
                                    </div>
                                </div>
                            }
                        </div>
                    </div>
                </div>

               
            </div>
        }

        <!-- Tab ƒê∆°n H√†ng -->
        @if (ActiveTab == "donhang")
        {
            <div class="tab-pane fade show active" role="tabpanel">
                <!-- Th·ªëng k√™ ƒë∆°n h√†ng theo th·ªùi gian - Compact -->
                <div class="row mb-3">
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact bg-primary">
                            <div class="stat-icon"><i class="bi bi-calendar-day"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">H√¥m Nay</div>
                                <div class="stat-value">@ThongKeDonHang.DonHangHomNay</div>
                                <div class="stat-subtitle">@ThongKeDonHang.DoanhThuHomNay.ToString("N0") VNƒê</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact bg-success">
                            <div class="stat-icon"><i class="bi bi-calendar-month"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Th√°ng N√†y</div>
                                <div class="stat-value">@ThongKeDonHang.DonHangThangNay</div>
                                <div class="stat-subtitle">@ThongKeDonHang.DoanhThuThangNay.ToString("N0") VNƒê</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-12 mb-2">
                        <div class="stat-card-compact bg-info">
                            <div class="stat-icon"><i class="bi bi-calendar-year"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">NƒÉm N√†y</div>
                                <div class="stat-value">@ThongKeDonHang.DonHangNamNay</div>
                                <div class="stat-subtitle">@ThongKeDonHang.DoanhThuNamNay.ToString("N0") VNƒê</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Th·ªëng k√™ tr·∫°ng th√°i h√¥m nay - Compact -->
                <div class="row mb-3">
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact status-success">
                            <div class="stat-icon"><i class="bi bi-check-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">ƒê√£ Thanh To√°n</div>
                                <div class="stat-value">@ThongKeDonHang.DaThanhToanHomNay</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-6 mb-2">
                        <div class="stat-card-compact status-warning">
                            <div class="stat-icon"><i class="bi bi-clock"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">Ch·ªù Thanh To√°n</div>
                                <div class="stat-value">@ThongKeDonHang.ChoThanhToanHomNay</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4 col-md-4 col-sm-12 mb-2">
                        <div class="stat-card-compact status-danger">
                            <div class="stat-icon"><i class="bi bi-x-circle"></i></div>
                            <div class="stat-content">
                                <div class="stat-label">ƒê√£ H·ªßy</div>
                                <div class="stat-value">@ThongKeDonHang.DaHuyHomNay</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Filter - Compact -->
                <div class="card mb-3">
                    <div class="card-header bg-light py-2">
                        <h6 class="mb-0"><i class="bi bi-funnel"></i> L·ªçc Theo Th·ªùi Gian</h6>
                    </div>
                    <div class="card-body py-3">
                     

                        @if (FilterType != "all")
                        {
                            <div class="mt-3">
                                <div class="alert alert-info">
                                    <i class="bi bi-info-circle"></i>
                                    K·∫øt qu·∫£ l·ªçc: <strong>@ThongKeDonHang.DonHangFiltered</strong> ƒë∆°n h√†ng
                                    | Doanh thu: <strong>@ThongKeDonHang.DoanhThuFiltered.ToString("N0") VNƒê</strong>
                                </div>
                            </div>
                        }
                    </div>
                </div>

            </div>
        }

        <!-- Tab Doanh Thu -->
        @if (ActiveTab == "doanhthu")
        {
            <div class="tab-pane fade show active" role="tabpanel">
                <div class="card">
                    <div class="card-header bg-light">
                        <h5 class="mb-0"><i class="bi bi-graph-up-arrow"></i> Th·ªëng K√™ Doanh Thu</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <div class="revenue-card">
                                    <div class="revenue-label">Doanh Thu H√¥m Nay</div>
                                    <div class="revenue-value text-primary">@DoanhThuHomNay.ToString("N0") VNƒê</div>
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <div class="revenue-card">
                                    <div class="revenue-label">Doanh Thu Th√°ng N√†y</div>
                                    <div class="revenue-value text-success">@DoanhThuThangNay.ToString("N0") VNƒê</div>
                                </div>
                            </div>
                            <div class="col-12">
                                <div class="revenue-card revenue-total">
                                    <div class="revenue-label">T·ªïng Doanh Thu</div>
                                    <div class="revenue-value-large text-info">@DoanhThuTong.ToString("N0") VNƒê</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        }
    </div>
</div>

@* Loading indicator *@
@if (IsLoading)
{
    <div class="loading-overlay">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}

<style>
    .statistics-container {
        padding: 20px;
        background-color: #f4f6f9;
        min-height: 100vh;
    }

    .main-title-container {
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-bottom: 2px solid #e0e0e0;
        padding-bottom: 15px;
    }

    .dashboard-main-title {
        color: #3f4c6b;
        font-weight: 700;
        font-size: 28px;
        margin: 0;
    }

    .dashboard-main-title i {
        color: #ff9800;
        margin-right: 10px;
    }

    /* Stat Cards */
    .stat-card {
        border-radius: 12px;
        color: white;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        overflow: hidden;
        transition: transform 0.3s ease;
    }

    .stat-card:hover {
        transform: translateY(-5px);
    }

    /* Compact Stat Cards */
    .stat-card-compact {
        border-radius: 8px;
        color: white;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 12px 15px;
        display: flex;
        align-items: center;
        gap: 12px;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        height: 100%;
    }

    .stat-card-compact:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .stat-card-compact .stat-icon {
        font-size: 24px;
        opacity: 0.9;
        flex-shrink: 0;
    }

    .stat-card-compact .stat-content {
        flex: 1;
        min-width: 0;
    }

    .stat-card-compact .stat-label {
        font-size: 11px;
        opacity: 0.9;
        margin-bottom: 4px;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .stat-card-compact .stat-value {
        font-size: 20px;
        font-weight: 700;
        line-height: 1.2;
    }

    .stat-card-compact .stat-value-small {
        font-size: 14px;
        font-weight: 600;
        line-height: 1.2;
    }

    .stat-card-compact .stat-value-large {
        font-size: 18px;
        font-weight: 700;
        line-height: 1.2;
    }

    .stat-card-compact .stat-subtitle {
        font-size: 11px;
        opacity: 0.85;
        margin-top: 2px;
        font-weight: 500;
    }

    .stat-card-compact.status-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
    }

    .stat-card-compact.status-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    }

    .stat-card-compact.status-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
    }

    .stat-card-header {
        padding: 15px 20px;
        font-size: 14px;
        font-weight: 600;
        background-color: rgba(0, 0, 0, 0.1);
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .stat-card-body {
        padding: 25px 20px;
        font-size: 32px;
        font-weight: 700;
        line-height: 1;
    }

    .stat-card-body-small {
        padding: 20px;
        font-size: 24px;
        font-weight: 700;
        line-height: 1.3;
    }

    .stat-card-subtitle {
        font-size: 16px;
        font-weight: 500;
        opacity: 0.9;
        margin-top: 8px;
    }

    .stat-card-body-large {
        padding: 35px 20px;
        font-size: 48px;
        font-weight: 700;
        line-height: 1;
        text-align: center;
    }

    /* Status Stat Cards */
    .status-stat-card {
        border-radius: 12px;
        padding: 20px;
        text-align: center;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    .status-success {
        background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        color: white;
    }

    .status-warning {
        background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        color: white;
    }

    .status-danger {
        background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
        color: white;
    }

    .status-label {
        font-size: 14px;
        opacity: 0.9;
        margin-bottom: 10px;
    }

    .status-value {
        font-size: 36px;
        font-weight: 700;
    }

    .bg-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important; }
    .bg-success { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%) !important; }
    .bg-warning { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important; }
    .bg-info { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%) !important; }
    .bg-gradient { background: linear-gradient(135deg, #fa709a 0%, #fee140 100%) !important; }

    /* Tabs */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
    }

    .nav-tabs .nav-link {
        color: #6c757d;
        border: none;
        border-bottom: 3px solid transparent;
        padding: 12px 20px;
        font-weight: 600;
        cursor: pointer;
    }

    .nav-tabs .nav-link:hover {
        border-bottom-color: #ff9800;
        color: #ff9800;
    }

    .nav-tabs .nav-link.active {
        color: #ff9800;
        background-color: transparent;
        border-bottom-color: #ff9800;
    }

    /* Age Statistics */
    .age-stat-item {
        background: white;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .age-label {
        font-size: 14px;
        color: #6c757d;
        margin-bottom: 8px;
    }

    .age-value {
        font-size: 24px;
        font-weight: 700;
        color: #3f4c6b;
    }

    /* Revenue Cards */
    .revenue-card {
        background: white;
        border-radius: 12px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        text-align: center;
    }

    .revenue-card.revenue-total {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
    }

    .revenue-label {
        font-size: 16px;
        color: #6c757d;
        margin-bottom: 10px;
    }

    .revenue-card.revenue-total .revenue-label {
        color: rgba(255, 255, 255, 0.9);
    }

    .revenue-value {
        font-size: 28px;
        font-weight: 700;
    }

    .revenue-value-large {
        font-size: 40px;
        font-weight: 700;
        color: white !important;
    }

    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
</style>

@code {
    private const int PAGE_SIZE = 5;
    private const string KHACH_HANG_ROLE = "KhachHang";

    // T·ªïng quan th·ªëng k√™
    private int TongKhachHang { get; set; }
    private int TongDonHang { get; set; }
    private decimal DoanhThuHomNay { get; set; }
    private decimal DoanhThuThangNay { get; set; }
    private decimal DoanhThuTong { get; set; }

    // Th·ªëng k√™ kh√°ch h√†ng theo ƒë·ªô tu·ªïi
    private Dictionary<string, int> ThongKeTheoDoTuoi { get; set; } = new();


    // Th·ªëng k√™ ƒë∆°n h√†ng theo th·ªùi gian
    private ThongKeDonHangViewModel ThongKeDonHang { get; set; } = new();

    // Filter th·ªùi gian
    private string FilterType { get; set; } = "all";
    private DateTime? FilterDate { get; set; }
    private int? FilterMonth { get; set; }
    private int? FilterYear { get; set; }

    // UI State
    private string ActiveTab { get; set; } = "khachhang";
    private string ErrorMessage { get; set; } = string.Empty;
    private bool HasError => !string.IsNullOrEmpty(ErrorMessage);
    private bool IsLoading { get; set; } = false;

    // Filter Model
    private FilterModel filterModel = new();

    private bool _isFirstLoad = true;
    private string _lastUrl = string.Empty;
    private bool _isHandlingPagination = false; // Flag to prevent OnParametersSetAsync from reloading during pagination

    protected override Task OnInitializedAsync()
    {
        // Blazor lifecycle method - load data (no JS calls here during prerendering)
        // Don't load here, wait for OnParametersSetAsync to avoid double loading
        return Task.CompletedTask;
    }


  
  

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // JS interop can only be called in OnAfterRenderAsync when prerendering is enabled
            try
            {
                await JSRuntime.InvokeVoidAsync("console.log", "‚úÖ Blazor Statistics Page Loaded");
                await JSRuntime.InvokeVoidAsync("console.log", "üöÄ Blazor OnInitializedAsync called");
                await JSRuntime.InvokeVoidAsync("console.log", "‚ú® Blazor Component Rendered Successfully");
                
                // Try to check for Blazor SignalR connection
                try
                {
                    var isConnected = await JSRuntime.InvokeAsync<bool>("eval", 
                        "window.Blazor && typeof window.Blazor.start === 'function'");
                    await JSRuntime.InvokeVoidAsync("console.log", 
                        $"üîó Blazor Hub Connection Status: {(isConnected ? "Connected" : "Checking...")}");
                }
                catch
                {
                    // Ignore if check fails
                }
            }
            catch
            {
                // Ignore JS errors during prerendering
            }
        }
    }


    private async Task LoadTongQuanThongKe()
    {
        try
        {
            var khachHangRoleId = await Context.VaiTro
                .Where(r => r.TenVaiTro == KHACH_HANG_ROLE)
                .Select(r => r.RoleId)
                .FirstOrDefaultAsync();

            if (khachHangRoleId != null)
            {
                TongKhachHang = await Context.UserRole
                    .Where(ur => ur.RoleId == khachHangRoleId)
                    .CountAsync();
            }

            TongDonHang = await Context.DonHang.CountAsync();

            var today = DateTime.Today;
            DoanhThuHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var firstDayOfMonth = new DateTime(today.Year, today.Month, 1);
            DoanhThuThangNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfMonth && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            DoanhThuTong = await Context.DonHang
                .Where(d => d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n")
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;
        }
        catch (Exception ex)
        {
            throw new Exception($"L·ªói khi t·∫£i t·ªïng quan th·ªëng k√™: {ex.Message}", ex);
        }
    }

    private async Task LoadThongKeKhachHangTheoDoTuoi()
    {
        try
        {
            var khachHangRoleId = await Context.VaiTro
                .Where(r => r.TenVaiTro == KHACH_HANG_ROLE)
                .Select(r => r.RoleId)
                .FirstOrDefaultAsync();

            if (khachHangRoleId == null) return;

            var now = DateTime.Now;
            var currentYear = now.Year;
            var currentDayOfYear = now.DayOfYear;

            // T√≠nh to√°n tu·ªïi tr·ª±c ti·∫øp trong database query ƒë·ªÉ t·ªëi ∆∞u performance
            var ageGroups = await Context.UserRole
                .Where(ur => ur.RoleId == khachHangRoleId)
                .Join(Context.NguoiDung,
                    ur => ur.UserId,
                    nd => nd.UserId,
                    (ur, nd) => nd)
                .Where(nd => nd.NgaySinh != null)
                .Select(nd => new
                {
                    BirthYear = nd.NgaySinh.Value.Year,
                    BirthDayOfYear = nd.NgaySinh.Value.DayOfYear
                })
                .ToListAsync();

            ThongKeTheoDoTuoi = new Dictionary<string, int>
            {
                { "D∆∞·ªõi 18 tu·ªïi", 0 },
                { "18-25 tu·ªïi", 0 },
                { "26-35 tu·ªïi", 0 },
                { "36-45 tu·ªïi", 0 },
                { "46-60 tu·ªïi", 0 },
                { "Tr√™n 60 tu·ªïi", 0 }
            };

            foreach (var kh in ageGroups)
            {
                var tuoi = currentYear - kh.BirthYear;
                if (kh.BirthDayOfYear > currentDayOfYear) tuoi--;

                if (tuoi < 18)
                    ThongKeTheoDoTuoi["D∆∞·ªõi 18 tu·ªïi"]++;
                else if (tuoi <= 25)
                    ThongKeTheoDoTuoi["18-25 tu·ªïi"]++;
                else if (tuoi <= 35)
                    ThongKeTheoDoTuoi["26-35 tu·ªïi"]++;
                else if (tuoi <= 45)
                    ThongKeTheoDoTuoi["36-45 tu·ªïi"]++;
                else if (tuoi <= 60)
                    ThongKeTheoDoTuoi["46-60 tu·ªïi"]++;
                else
                    ThongKeTheoDoTuoi["Tr√™n 60 tu·ªïi"]++;
            }
        }
        catch (Exception ex)
        {
            throw new Exception($"L·ªói khi th·ªëng k√™ theo ƒë·ªô tu·ªïi: {ex.Message}", ex);
        }
    }

    private async Task LoadThongKeDonHang()
    {
        try
        {
            var today = DateTime.Today;
            var firstDayOfMonth = new DateTime(today.Year, today.Month, 1);
            var lastDayOfMonth = firstDayOfMonth.AddMonths(1).AddDays(-1);
            var firstDayOfYear = new DateTime(today.Year, 1, 1);
            var lastDayOfYear = new DateTime(today.Year, 12, 31);

            // Th·ªëng k√™ theo filter (c·∫ßn build query tr∆∞·ªõc)
            var filteredQuery = Context.DonHang.AsQueryable();

            if (FilterType == "day" && FilterDate.HasValue)
            {
                filteredQuery = filteredQuery.Where(d => d.NgayDat.Date == FilterDate.Value.Date);
            }
            else if (FilterType == "month" && FilterMonth.HasValue && FilterYear.HasValue)
            {
                var startOfMonth = new DateTime(FilterYear.Value, FilterMonth.Value, 1);
                var endOfMonth = startOfMonth.AddMonths(1).AddDays(-1);
                filteredQuery = filteredQuery.Where(d => d.NgayDat >= startOfMonth && d.NgayDat <= endOfMonth);
            }
            else if (FilterType == "year" && FilterYear.HasValue)
            {
                var startOfYear = new DateTime(FilterYear.Value, 1, 1);
                var endOfYear = new DateTime(FilterYear.Value, 12, 31);
                filteredQuery = filteredQuery.Where(d => d.NgayDat >= startOfYear && d.NgayDat <= endOfYear);
            }

            // Ch·∫°y c√°c query tu·∫ßn t·ª± v√¨ DbContext kh√¥ng thread-safe
            var donHangHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today)
                .CountAsync();

            var doanhThuHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var donHangThangNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfMonth && d.NgayDat <= lastDayOfMonth)
                .CountAsync();

            var doanhThuThangNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfMonth && d.NgayDat <= lastDayOfMonth && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var donHangNamNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfYear && d.NgayDat <= lastDayOfYear)
                .CountAsync();

            var doanhThuNamNay = await Context.DonHang
                .Where(d => d.NgayDat >= firstDayOfYear && d.NgayDat <= lastDayOfYear && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var donHangFiltered = await filteredQuery.CountAsync();
            var doanhThuFiltered = await filteredQuery
                .Where(d => d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n")
                .SumAsync(d => (decimal?)d.TongTien) ?? 0;

            var daThanhToanHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da thanh toan" || d.TrangThaiThanhToan == "ƒê√£ thanh to√°n"))
                .CountAsync();

            var choThanhToanHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && d.TrangThaiThanhToan == "DangChoThanhToan")
                .CountAsync();

            var daHuyHomNay = await Context.DonHang
                .Where(d => d.NgayDat.Date == today && (d.TrangThaiThanhToan == "Da huy" || d.TrangThaiThanhToan == "ƒê√£ h·ªßy"))
                .CountAsync();

            ThongKeDonHang = new ThongKeDonHangViewModel
            {
                DonHangHomNay = donHangHomNay,
                DoanhThuHomNay = doanhThuHomNay,
                DonHangThangNay = donHangThangNay,
                DoanhThuThangNay = doanhThuThangNay,
                DonHangNamNay = donHangNamNay,
                DoanhThuNamNay = doanhThuNamNay,
                DonHangFiltered = donHangFiltered,
                DoanhThuFiltered = doanhThuFiltered,
                DaThanhToanHomNay = daThanhToanHomNay,
                ChoThanhToanHomNay = choThanhToanHomNay,
                DaHuyHomNay = daHuyHomNay
            };
        }
        catch (Exception ex)
        {
            throw new Exception($"L·ªói khi th·ªëng k√™ ƒë∆°n h√†ng: {ex.Message}", ex);
        }
    }


    private void HandleDatabaseError(DbUpdateException ex)
    {
        if (ex.InnerException is SqlException sqlEx)
        {
            HandleSqlError(sqlEx);
        }
        else
        {
            ErrorMessage = $"L·ªói c·∫≠p nh·∫≠t c∆° s·ªü d·ªØ li·ªáu: {ex.Message}";
        }
    }

    private void HandleSqlError(SqlException ex)
    {
        switch (ex.Number)
        {
            case 547:
                ErrorMessage = "Kh√¥ng th·ªÉ th·ª±c hi·ªán thao t√°c n√†y do vi ph·∫°m r√†ng bu·ªôc kh√≥a ngo·∫°i. Vui l√≤ng ki·ªÉm tra d·ªØ li·ªáu li√™n quan.";
                break;
            case 2627:
            case 2601:
                ErrorMessage = "L·ªói kh√≥a ch√≠nh: D·ªØ li·ªáu ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng.";
                break;
            case 2:
                ErrorMessage = "Kh√¥ng th·ªÉ k·∫øt n·ªëi ƒë·∫øn c∆° s·ªü d·ªØ li·ªáu. Vui l√≤ng th·ª≠ l·∫°i sau.";
                break;
            default:
                ErrorMessage = $"L·ªói SQL (M√£: {ex.Number}): {ex.Message}";
                break;
        }
    }

    private void UpdateFilterFields()
    {
        // This will be handled by the conditional rendering
        StateHasChanged();
    }

   


    public void Dispose()
    {
        // Cleanup if needed
    }

    public class ThongKeDonHangViewModel
    {
        public int DonHangHomNay { get; set; }
        public decimal DoanhThuHomNay { get; set; }
        public int DonHangThangNay { get; set; }
        public decimal DoanhThuThangNay { get; set; }
        public int DonHangNamNay { get; set; }
        public decimal DoanhThuNamNay { get; set; }
        public int DonHangFiltered { get; set; }
        public decimal DoanhThuFiltered { get; set; }
        public int DaThanhToanHomNay { get; set; }
        public int ChoThanhToanHomNay { get; set; }
        public int DaHuyHomNay { get; set; }
    }

    public class FilterModel
    {
        public string FilterType { get; set; } = "all";
        public DateTime? FilterDate { get; set; }
        public int? FilterMonth { get; set; }
        public int? FilterYear { get; set; } = DateTime.Now.Year;
    }
}


