@using AdminDashboard.Models
@using AdminDashboard.Areas.Admin.Components
@using Microsoft.AspNetCore.Components
@inject IJSRuntime JSRuntime
@implements IDisposable

@* Blazor Component for Customer List with Age Filtering *@
<div class="khachhang-list-container">
    <!-- Filter theo ƒë·ªô tu·ªïi -->
    <div class="card mb-3">
        <div class="card-header bg-light">
            <h6 class="mb-0"><i class="bi bi-funnel"></i> L·ªçc Theo ƒê·ªô Tu·ªïi</h6>
        </div>
        <div class="card-body">
            <div class="age-filter-buttons">
                <button type="button" 
                        class="btn btn-sm @(SelectedAgeFilter == null ? "btn-primary" : "btn-outline-primary")"
                        @onclick="@(() => FilterByAge(null))"
                        @onclick:preventDefault="true">
                    T·∫•t C·∫£
                </button>
                <button type="button" 
                        class="btn btn-sm @(SelectedAgeFilter == "duoi18" ? "btn-primary" : "btn-outline-primary")"
                        @onclick="@(() => FilterByAge("duoi18"))"
                        @onclick:preventDefault="true">
                    D∆∞·ªõi 18 tu·ªïi
                </button>
                <button type="button" 
                        class="btn btn-sm @(SelectedAgeFilter == "18-25" ? "btn-primary" : "btn-outline-primary")"
                        @onclick="@(() => FilterByAge("18-25"))"
                        @onclick:preventDefault="true">
                    18-25 tu·ªïi
                </button>
                <button type="button" 
                        class="btn btn-sm @(SelectedAgeFilter == "26-35" ? "btn-primary" : "btn-outline-primary")"
                        @onclick="@(() => FilterByAge("26-35"))"
                        @onclick:preventDefault="true">
                    26-35 tu·ªïi
                </button>
                <button type="button" 
                        class="btn btn-sm @(SelectedAgeFilter == "36-45" ? "btn-primary" : "btn-outline-primary")"
                        @onclick="@(() => FilterByAge("36-45"))"
                        @onclick:preventDefault="true">
                    36-45 tu·ªïi
                </button>
                <button type="button" 
                        class="btn btn-sm @(SelectedAgeFilter == "46-60" ? "btn-primary" : "btn-outline-primary")"
                        @onclick="@(() => FilterByAge("46-60"))"
                        @onclick:preventDefault="true">
                    46-60 tu·ªïi
                </button>
                <button type="button" 
                        class="btn btn-sm @(SelectedAgeFilter == "tren60" ? "btn-primary" : "btn-outline-primary")"
                        @onclick="@(() => FilterByAge("tren60"))"
                        @onclick:preventDefault="true">
                    Tr√™n 60 tu·ªïi
                </button>
            </div>
            @if (SelectedAgeFilter != null)
            {
                <div class="mt-2">
                    <span class="text-info">
                        <i class="bi bi-info-circle"></i> ƒêang highlight: <strong>@GetAgeFilterLabel(SelectedAgeFilter)</strong>
                    </span>
                </div>
            }
        </div>
    </div>

    <!-- Danh s√°ch kh√°ch h√†ng -->
    @if (KhachHangs == null || !KhachHangs.Any())
    {
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Kh√¥ng c√≥ d·ªØ li·ªáu kh√°ch h√†ng.
        </div>
    }
    else
    {
        <div class="table-responsive">
            <table class="table modern-table table-hover">
                <thead>
                    <tr>
                        <th>M√£ KH</th>
                        <th>T√™n Kh√°ch H√†ng</th>
                        <th>Email</th>
                        <th>S·ªë ƒêi·ªán Tho·∫°i</th>
                        <th>Ng√†y Sinh</th>
                        <th>Tu·ªïi</th>
                        <th>Tr·∫°ng Th√°i</th>
                        <th>Thao T√°c</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var kh in FilteredKhachHangs)
                    {
                        var isSelected = SelectedUserId == kh.UserId;
                        var isAgeHighlight = SelectedAgeFilter != null && IsInAgeRange(kh.Tuoi, SelectedAgeFilter);
                        
                        // X√¢y d·ª±ng class cho row - ∆∞u ti√™n age highlight
                        var rowClass = "";
                        var rowStyle = "cursor: pointer;";
                        
                        if (isAgeHighlight)
                        {
                            rowClass = "age-highlight";
                            rowStyle += " background-color: #fff3cd !important; border-left: 4px solid #ffc107 !important; font-weight: bold !important;";
                        }
                        if (isSelected)
                        {
                            rowClass += (string.IsNullOrEmpty(rowClass) ? "" : " ") + "selected-row";
                        }
                        
                        <tr class="@rowClass" 
                            @onclick="() => SelectRow(kh.UserId)"
                            style="@rowStyle">
                            <td>
                                <span class="badge @(isAgeHighlight ? "bg-warning text-dark" : "bg-secondary")">@kh.UserId</span>
                            </td>
                            <td>
                                <span style="@(isAgeHighlight ? "font-weight: bold !important;" : "")">@kh.HoTen</span>
                                @if (isSelected)
                                {
                                    <i class="bi bi-check-circle-fill text-primary ms-1"></i>
                                }
                            </td>
                            <td>
                                <span style="@(isAgeHighlight ? "font-weight: bold !important;" : "")">@kh.Email</span>
                            </td>
                            <td>
                                <span style="@(isAgeHighlight ? "font-weight: bold !important;" : "")">@kh.SoDienThoai</span>
                            </td>
                            <td>
                                <span style="@(isAgeHighlight ? "font-weight: bold !important;" : "")">@(kh.NgaySinh?.ToString("dd/MM/yyyy") ?? "‚Äî")</span>
                            </td>
                            <td>
                                @if (kh.Tuoi.HasValue)
                                {
                                    <span class="@(isAgeHighlight ? "fw-bold text-primary" : "")" style="@(isAgeHighlight ? "font-weight: bold !important; color: #0d6efd !important; font-size: 1.1em;" : "")">@kh.Tuoi.Value</span>
                                }
                                else
                                {
                                    <span>‚Äî</span>
                                }
                            </td>
                            <td>
                                @if (kh.TrangThai == TrangThaiNguoiDung.HoatDong)
                                {
                                    <span class="badge-status badge-success">Ho·∫°t ƒë·ªông</span>
                                }
                                else
                                {
                                    <span class="badge-status badge-danger">B·ªã kh√≥a</span>
                                }
                            </td>
                            <td>
                                <button class="btn btn-sm btn-danger" 
                                        @onclick:stopPropagation="true"
                                        @onclick="() => DeleteKhachHang(kh.UserId, kh.HoTen)">
                                    <i class="bi bi-trash"></i> X√≥a
                                </button>
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>

        <!-- Pagination -->
        @if (KhachHangs != null && KhachHangs.TotalPages > 1)
        {
            <div class="pagination-wrapper">
                <div class="page-info">
                    Trang @KhachHangs.PageIndex / @KhachHangs.TotalPages 
                    (T·ªïng: @KhachHangs.TotalCount kh√°ch h√†ng)
                </div>
                <nav>
                    <ul class="pagination mb-0">
                        @if (KhachHangs.HasPreviousPage)
                        {
                            <li class="page-item">
                                <a class="page-link" href="#" @onclick="@(() => HandlePageChange(KhachHangs.PageIndex - 1))" @onclick:preventDefault="true">
                                    <i class="bi bi-chevron-left"></i> Tr∆∞·ªõc
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item disabled">
                                <span class="page-link"><i class="bi bi-chevron-left"></i> Tr∆∞·ªõc</span>
                            </li>
                        }

                        @for (int i = Math.Max(1, KhachHangs.PageIndex - 2); 
                             i <= Math.Min(KhachHangs.TotalPages, KhachHangs.PageIndex + 2); 
                             i++)
                        {
                            var pageNum = i; // Capture loop variable to avoid closure issue
                            <li class="page-item @(pageNum == KhachHangs.PageIndex ? "active" : "")">
                                <a class="page-link" href="#" @onclick="@(() => HandlePageChange(pageNum))" @onclick:preventDefault="true">@pageNum</a>
                            </li>
                        }

                        @if (KhachHangs.HasNextPage)
                        {
                            <li class="page-item">
                                <a class="page-link" href="#" @onclick="@(() => HandlePageChange(KhachHangs.PageIndex + 1))" @onclick:preventDefault="true">
                                    Sau <i class="bi bi-chevron-right"></i>
                                </a>
                            </li>
                        }
                        else
                        {
                            <li class="page-item disabled">
                                <span class="page-link">Sau <i class="bi bi-chevron-right"></i></span>
                            </li>
                        }
                    </ul>
                </nav>
            </div>
        }
    }
</div>

<style>
    .khachhang-list-container {
        width: 100%;
    }

    .selected-row {
        background-color: #e7f3ff !important;
        border-left: 4px solid #0d6efd;
        font-weight: 600;
    }

    .age-highlight {
        background-color: #fff3cd !important;
        border-left: 4px solid #ffc107 !important;
        font-weight: 700 !important;
    }

    .age-highlight:hover {
        background-color: #ffe69c !important;
    }
    
    .age-highlight td {
        background-color: #fff3cd !important;
        font-weight: 700 !important;
    }
    
    .age-highlight:hover td {
        background-color: #ffe69c !important;
        font-weight: 700 !important;
    }
    
    .age-highlight td * {
        font-weight: 700 !important;
    }

    .selected-row:hover {
        background-color: #d0e7ff !important;
    }

    .table tbody tr {
        transition: all 0.2s ease;
    }

    .table tbody tr:hover {
        transform: scale(1.01);
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .age-filter-buttons {
        display: flex;
        flex-wrap: wrap;
        gap: 8px;
    }

    .age-filter-buttons .btn {
        margin: 0;
    }
</style>

@code {
    [Parameter]
    public PaginatedList<NguoiDungViewModel>? KhachHangs { get; set; }

    [Parameter]
    public int DonHangPageIndex { get; set; } = 1;

    [Parameter]
    public string DeleteUrl { get; set; } = "";

    [Parameter]
    public EventCallback<int> OnPageChange { get; set; }

    private string? SelectedUserId { get; set; }
    private string? SelectedAgeFilter { get; set; }

    private IEnumerable<NguoiDungViewModel> FilteredKhachHangs
    {
        get
        {
            if (KhachHangs == null || !KhachHangs.Any())
                return Enumerable.Empty<NguoiDungViewModel>();

            // Lu√¥n hi·ªÉn th·ªã t·∫•t c·∫£, ch·ªâ highlight theo filter
            return KhachHangs.ToList();
        }
    }

    private bool IsInAgeRange(int? tuoi, string? ageFilter)
    {
        if (!tuoi.HasValue || string.IsNullOrEmpty(ageFilter))
            return false;

        var age = tuoi.Value;
        
        return ageFilter switch
        {
            "duoi18" => age < 18,
            "18-25" => age >= 18 && age <= 25,
            "26-35" => age >= 26 && age <= 35,
            "36-45" => age >= 36 && age <= 45,
            "46-60" => age >= 46 && age <= 60,
            "tren60" => age > 60,
            _ => false
        };
    }

    private string GetAgeFilterLabel(string? ageFilter)
    {
        return ageFilter switch
        {
            "duoi18" => "D∆∞·ªõi 18 tu·ªïi",
            "18-25" => "18-25 tu·ªïi",
            "26-35" => "26-35 tu·ªïi",
            "36-45" => "36-45 tu·ªïi",
            "46-60" => "46-60 tu·ªïi",
            "tren60" => "Tr√™n 60 tu·ªïi",
            _ => ""
        };
    }

    private void SelectRow(string userId)
    {
        SelectedUserId = SelectedUserId == userId ? null : userId;
        StateHasChanged(); // Force re-render
    }

    private async Task FilterByAge(string? ageFilter)
    {
        // Toggle filter - n·∫øu ƒëang ch·ªçn th√¨ b·ªè, n·∫øu ch∆∞a ch·ªçn th√¨ ch·ªçn
        if (SelectedAgeFilter == ageFilter)
        {
            SelectedAgeFilter = null;
        }
        else
        {
            SelectedAgeFilter = ageFilter;
        }
        SelectedUserId = null; // Reset selection when filtering
        
        // Force re-render
        await InvokeAsync(StateHasChanged);
    }

    private async Task DeleteKhachHang(string userId, string hoTen)
    {
        if (await JSRuntime.InvokeAsync<bool>("confirm", $"B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën x√≥a kh√°ch h√†ng \"{hoTen}\"?"))
        {
            await JSRuntime.InvokeVoidAsync("xoaKhachHang", userId, hoTen);
        }
    }

    private async Task HandlePageChange(int pageIndex)
    {
        try
        {
            await JSRuntime.InvokeVoidAsync("console.log", 
                $"üîµ KhachHangList.HandlePageChange called with pageIndex: {pageIndex}, KhachHangs.PageIndex: {KhachHangs?.PageIndex}");
        }
        catch { }
        
        if (OnPageChange.HasDelegate)
        {
            await OnPageChange.InvokeAsync(pageIndex);
        }
    }

    public void Dispose()
    {
        // Cleanup if needed
    }
}

