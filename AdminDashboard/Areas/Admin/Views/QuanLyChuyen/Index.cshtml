@model IEnumerable<AdminDashboard.Models.ChuyenXe>
@using AdminDashboard.Models.TrangThai

@{
    ViewData["Title"] = "Duyệt Lịch Chạy";
    int currentStatus = ViewBag.CurrentStatus;
}

<div class="container-fluid px-4">
    <h2 class="mt-4 fw-bold text-primary">QUẢN LÝ DUYỆT CHUYẾN</h2>
    <hr class="mb-4" />

    <div class="mb-3">
        <a asp-action="Index" asp-route-trangThai="-1" class="btn @(currentStatus == -1 ? "btn-warning fw-bold" : "btn-light border") me-2">
            <i class="fas fa-clock"></i> Chờ Duyệt 
            @if(currentStatus == -1 && Model.Any()) { <span class="badge bg-danger ms-1">@Model.Count()</span> }
        </a>
        <a asp-action="Index" asp-route-trangThai="0" class="btn @(currentStatus == 0 ? "btn-success fw-bold" : "btn-light border") me-2">
            <i class="fas fa-check"></i> Đã Duyệt
        </a>
        <a asp-action="Index" asp-route-trangThai="-99" class="btn @(currentStatus == -99 ? "btn-primary fw-bold" : "btn-light border")">
            <i class="fas fa-list"></i> Tất cả
        </a>
    </div>

    <form asp-action="DuyetNhanh" method="post">
        
        @if (currentStatus == -1 && Model.Any())
        {
            <div class="card bg-light border-warning mb-3 shadow-sm">
                <div class="card-body p-2 d-flex align-items-center justify-content-between">
                    <div class="form-check ms-2">
                        <input type="checkbox" id="selectAll" class="form-check-input" style="cursor:pointer; transform: scale(1.3);">
                        <label for="selectAll" class="form-check-label fw-bold ms-2">Chọn tất cả (@Model.Count())</label>
                    </div>
                    <button type="submit" class="btn btn-success fw-bold" id="btnBulk" disabled onclick="return confirm('Xác nhận duyệt các chuyến đã chọn?')">
                        <i class="fas fa-check-double"></i> DUYỆT NGAY (<span id="countDisplay">0</span>)
                    </button>
                </div>
            </div>
        }

        <div class="card shadow-sm border-0">
            <table class="table table-hover align-middle mb-0">
                <thead class="bg-light">
                    <tr>
                        <th width="50" class="text-center">#</th>
                        <th>Nhà Xe</th>
                        <th>Lộ Trình</th>
                        <th>Thời Gian</th>
                        <th>Xe</th>
                        <th>Trạng Thái</th>
                    </tr>
                </thead>
                <tbody>
                    @if (!Model.Any())
                    {
                        <tr><td colspan="6" class="text-center py-5 text-muted">Không có dữ liệu.</td></tr>
                    }
                    else
                    {
                        foreach (var item in Model)
                        {
                            <tr>
                                <td class="text-center">
                                    @if (item.TrangThai == TrangThaiChuyenXe.ChoDuyet)
                                    {
                                        <input type="checkbox" name="selectedIds" value="@item.ChuyenId" class="form-check-input item-check" style="cursor:pointer; transform: scale(1.2);">
                                    }
                                </td>
                                <td class="fw-bold text-primary">@item.Xe?.NhaXe?.TenNhaXe</td>
                                <td>@item.LoTrinh?.TramDiNavigation?.TenTram ➝ @item.LoTrinh?.TramToiNavigation?.TenTram</td>
                                <td>
                                    <b>@item.NgayDi.ToString("dd/MM/yyyy")</b><br>
                                    <span class="badge bg-light text-dark border">@item.GioDi.ToString(@"hh\:mm")</span>
                                </td>
                                <td><span class="badge bg-secondary">@item.Xe?.BienSoXe</span></td>
                                <td>
                                    @if(item.TrangThai == TrangThaiChuyenXe.ChoDuyet) { <span class="badge bg-warning text-dark">Chờ Duyệt</span> }
                                    else if(item.TrangThai == TrangThaiChuyenXe.DaLenLich) { <span class="badge bg-success">Đã Duyệt</span> }
                                    else { <span class="badge bg-secondary">@item.TrangThai</span> }
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        // Script xử lý chọn tất cả
        document.getElementById('selectAll')?.addEventListener('change', function() {
            var checkboxes = document.querySelectorAll('.item-check');
            checkboxes.forEach(cb => cb.checked = this.checked);
            updateCount();
        });

        var items = document.querySelectorAll('.item-check');
        items.forEach(cb => cb.addEventListener('change', updateCount));

        function updateCount() {
            var count = document.querySelectorAll('.item-check:checked').length;
            document.getElementById('countDisplay').innerText = count;
            document.getElementById('btnBulk').disabled = count === 0;
        }
    </script>
}