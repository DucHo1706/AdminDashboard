@using AdminDashboard.Models.TrangThai
@model IEnumerable<AdminDashboard.Models.ChuyenXe>
@{
    ViewData["Title"] = "Lịch Làm Việc Của Tôi";
    Layout = "~/Views/Shared/_LayoutTaiXe.cshtml";
}

<div class="container-fluid">
    <div class="d-sm-flex align-items-center justify-content-between mb-4">
        <h1 class="h3 mb-0 text-gray-800">@ViewData["Title"]</h1>
    </div>

    <!-- Thông báo -->
    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            <strong>Thành công!</strong> @TempData["SuccessMessage"]
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    }

    <!-- Bộ lọc -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Lọc lịch làm việc</h6>
        </div>
        <div class="card-body">
            <form method="get" class="form-inline">
                <div class="form-group mr-3">
                    <label for="tuNgay" class="mr-2">Từ ngày:</label>
                    <input type="date" class="form-control" id="tuNgay" name="tuNgay"
                           value="@ViewBag.TuNgay">
                </div>
                <div class="form-group mr-3">
                    <label for="denNgay" class="mr-2">Đến ngày:</label>
                    <input type="date" class="form-control" id="denNgay" name="denNgay"
                           value="@ViewBag.DenNgay">
                </div>
                <button type="submit" class="btn btn-primary">Lọc</button>
                <a href="@Url.Action("LichLamViec")" class="btn btn-secondary ml-2">Hiện tất cả</a>
            </form>
        </div>
    </div>

    <!-- Danh sách lịch làm việc -->
    <div class="card shadow mb-4">
        <div class="card-header py-3">
            <h6 class="m-0 font-weight-bold text-primary">Danh sách chuyến xe được phân công</h6>
        </div>
        <div class="card-body">
            @if (!Model.Any())
            {
                <div class="text-center">
                    <p class="text-muted">Bạn chưa có chuyến xe nào được phân công.</p>
                </div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-bordered" id="dataTable" width="100%" cellspacing="0">
                        <thead>
                            <tr>
                                <th>Mã Chuyến</th>
                                <th>Lộ Trình</th>
                                <th>Ngày Đi</th>
                                <th>Giờ Đi</th>
                                <th>Giờ Đến Dự Kiến</th>
                                <th>Xe</th>
                                <th>Trạng Thái</th>
                                <th class="text-center">Hành Động</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var chuyen in Model)
                            {
                                <tr>
                                    <td>@chuyen.ChuyenId</td>
                                    <td>
                                        @if (chuyen.LoTrinh?.TramDiNavigation != null && chuyen.LoTrinh?.TramToiNavigation != null)
                                        {
                                            <strong>@chuyen.LoTrinh.TramDiNavigation.TenTram</strong>
                                            <br />
                                            <small class="text-muted">→ @chuyen.LoTrinh.TramToiNavigation.TenTram</small>
                                        }
                                        else
                                        {
                                            <span class="text-danger">Chưa có thông tin lộ trình</span>
                                        }
                                    </td>
                                    <td>@chuyen.NgayDi.ToString("dd/MM/yyyy")</td>
                                    <td>@chuyen.GioDi.ToString(@"hh\:mm")</td>
                                    <td>@chuyen.GioDenDuKien.ToString(@"hh\:mm")</td>
                                    <td>
                                        @if (chuyen.Xe != null)
                                        {
                                            <div>
                                                <strong>@chuyen.Xe.BienSoXe</strong>
                                            </div>
                                        }
                                        else
                                        {
                                            <span class="text-warning">Chưa phân xe</span>
                                        }
                                    </td>
                                    <td>
                                        <span class="badge
                                                @(chuyen.TrangThai == TrangThaiChuyenXe.DaLenLich ? "badge-secondary" :
                                                                                        chuyen.TrangThai == TrangThaiChuyenXe.DangMoBanVe ? "badge-info" :
                                                                                        chuyen.TrangThai == TrangThaiChuyenXe.ChoKhoiHanh ? "badge-warning" :
                                                                                        chuyen.TrangThai == TrangThaiChuyenXe.DangDiChuyen ? "badge-primary" :
                                                                                        chuyen.TrangThai == TrangThaiChuyenXe.DaHoanThanh ? "badge-success" : "badge-danger")">
                                            @switch (chuyen.TrangThai)
                                            {
                                                case TrangThaiChuyenXe.DaLenLich:
                                                    <text>Đã Lên Lịch</text>
                                                    break;
                                                case TrangThaiChuyenXe.DangMoBanVe:
                                                    <text>Đang Mở Bán Vé</text>
                                                    break;
                                                case TrangThaiChuyenXe.ChoKhoiHanh:
                                                    <text>Chờ Khởi Hành</text>
                                                    break;
                                                case TrangThaiChuyenXe.DangDiChuyen:
                                                    <text>Đang Di Chuyển</text>
                                                    break;
                                                case TrangThaiChuyenXe.DaHoanThanh:
                                                    <text>Đã Hoàn Thành</text>
                                                    break;
                                                case TrangThaiChuyenXe.DaHuy:
                                                    <text>Đã Hủy</text>
                                                    break;
                                                default:
                                                    <text>@chuyen.TrangThai</text>
                                                    break;
                                            }
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        @if (chuyen.TrangThai == TrangThaiChuyenXe.ChoKhoiHanh)
                                        {
                                            <form asp-controller="TaiXe" asp-action="CheckInXuatBen" asp-route-id="@chuyen.ChuyenId" method="post">
                                                <button type="submit" class="btn btn-primary btn-sm" onclick="return confirm('Xác nhận xuất bến cho chuyến đi này?');">
                                                     Xuất Bến
                                                </button>
                                            </form>
                                        }
                                        else if (chuyen.TrangThai == TrangThaiChuyenXe.DangDiChuyen)
                                        {
                                            <form asp-controller="TaiXe" asp-action="CheckInDenNoi" asp-route-id="@chuyen.ChuyenId" method="post">
                                                <button type="submit" class="btn btn-info btn-sm" onclick="return confirm('Xác nhận đã hoàn thành chuyến đi?');">
                                                     Đã Đến Nơi
                                                </button>
                                            </form>
                                        }
                                        else
                                        {
                                            <button class="btn btn-secondary btn-sm" onclick="showChuyenDetail('@chuyen.ChuyenId')">
                                                <i class="fas fa-info-circle"></i> Chi tiết
                                            </button>
                                        }
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            }
        </div>
    </div>
</div>

<!-- Modal hiển thị chi tiết chuyến -->
<div class="modal fade" id="chuyenDetailModal" tabindex="-1" role="dialog" aria-labelledby="chuyenDetailModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="chuyenDetailModalLabel">Chi tiết chuyến xe</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body" id="chuyenDetailContent">
                <!-- Nội dung chi tiết sẽ được load bằng AJAX -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Đóng</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        function showChuyenDetail(chuyenId) {
            $.ajax({
                url: '@Url.Action("GetChuyenDetail", "TaiXe")',
                type: 'GET',
                data: { chuyenId: chuyenId },
                success: function (data) {
                    $('#chuyenDetailContent').html(data);
                    $('#chuyenDetailModal').modal('show');
                },
                error: function () {
                    alert('Có lỗi xảy ra khi tải thông tin chi tiết.');
                }
            });
        }

        // Tự động refresh trang mỗi 5 phút để cập nhật lịch
        setInterval(function() {
            location.reload();
        }, 300000); // 5 phút
    </script>
}