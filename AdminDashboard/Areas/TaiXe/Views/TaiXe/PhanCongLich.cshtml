@using AdminDashboard.Models.TrangThai
@model IEnumerable<AdminDashboard.Models.ChuyenXe>
@{
    Layout = "_Layout";
    ViewData["Title"] = "Phân Công Lịch Tài Xế";
    var taiXes = ViewBag.TaiXes as SelectList;
}

<style>
    h1 {
        text-align: center;
        font-size: 2.5em;
        font-weight: 700;
        color: #0033FF;
        text-transform: uppercase;
        margin: 20px;
    }
    .card-custom {
        border-radius: 14px;
        overflow: hidden;
        border: none;
        box-shadow: 0 4px 12px rgba(0,0,0,0.08);
    }

    .header-actions a {
        font-weight: 500;
        display: inline-flex;
        align-items: center;
        gap: 6px;
    }

    .table thead tr {
        background: #f8f9fc !important;
    }

    .table-hover tbody tr:hover {
        background-color: #f3f7ff;
    }

    .badge {
        padding: 7px 10px;
        font-size: 12px;
        font-weight: 600;
        text-transform: uppercase;
    }

    .select-driver {
        border-radius: 10px;
        padding: 6px 12px;
    }

    .btn-modern {
        border-radius: 10px;
        padding: 6px 14px;
    }

    .schedule-box {
        border-left: 4px solid #0d6efd;
        padding: 15px;
        background: #f8f9ff;
        border-radius: 10px;
        max-height: 500px;
        overflow-y: auto;
    }
    .schedule-day-header {
        font-size: 1.1rem;
        font-weight: 700;
        color: #0033FF;
        padding-bottom: 8px;
        border-bottom: 2px solid #e0e0e0;
        margin-top: 20px;
        margin-bottom: 15px;
    }

       .schedule-day-header:first-of-type {
            margin-top: 0;
        }
    .chuyen-card {
        background: #ffffff;
        border-radius: 18px;
        padding: 20px;
        box-shadow: 0 10px 25px rgba(0,0,0,0.08);
        margin-bottom: 20px;
        transition: all 0.3s ease;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex-wrap: wrap;
    }

    .chuyen-info {
        flex: 1;
        min-width: 250px;
    }

        .chuyen-info h5 {
            font-size: 1.2rem;
            margin-bottom: 10px;
            color: #1e293b;
        }

        .chuyen-info p {
            font-size: 0.95rem;
            color: #475569;
            margin: 3px 0;
        }

    .badge-secondary {
        background-color: #9ca3af;
        color: #fff;
    }

    .badge-info {
        background-color: #3b82f6;
        color: #fff;
    }

    .badge-warning {
        background-color: #facc15;
        color: #1e293b;
    }

    .badge-primary {
        background-color: #2563eb;
        color: #fff;
    }
    .badge-success {
        background-color: #22c55e;
        color: #fff;
    }
    .badge-danger {
        background-color: #ef4444;
        color: #fff;
    }
</style>


<div class="container-fluid py-4">

    <div class="text-center mb-4">
        <h1>@ViewData["Title"]</h1>
        <p class="text-muted">Quản lý phân công tài xế và theo dõi lịch làm việc</p>
    </div>

    <div class="d-flex justify-content-between align-items-center header-actions mb-4">
        <a asp-action="Index" class="text-decoration-none text-primary">
            <i class="bi bi-arrow-left"></i> Quay lại
        </a>

        <a asp-action="DanhSachPhanCong" class="btn btn-outline-primary btn-modern">
            <i class="fas fa-history"></i> Xem Lịch Sử Phân Công
        </a>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success fade show fw-semibold">@TempData["SuccessMessage"]</div>
    }
    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger fade show fw-semibold">@TempData["ErrorMessage"]</div>
    }

    <div class="card card-custom mb-5">
        <div class="card-header bg-primary text-white py-3">
            <h5 class="mb-0 fw-semibold"><i class="bi bi-truck"></i> Chuyến Xe Chưa Phân Công</h5>
        </div>

        <div class="card-body p-4">
            @if (!Model.Any())
            {
                <div class="text-center text-muted fst-italic">Không có chuyến xe nào cần phân công.</div>
            }
            else
            {
                <div class="table-responsive">
                    <table class="table table-hover align-middle">
                        <thead>
                            <tr>
                                <th>Mã</th>
                                <th>Lộ Trình</th>
                                <th>Ngày / Giờ</th>
                                <th>Xe</th>
                                <th>Trạng Thái</th>
                                <th>Tài Xế</th>
                                <th>Thao Tác</th>
                            </tr>
                        </thead>

                        <tbody>
                            @foreach (var chuyen in Model)
                            {
                                <tr>
                                    <td class="fw-semibold">@chuyen.ChuyenId</td>

                                    <td>
                                        @if (chuyen.LoTrinh?.TramDiNavigation != null)
                                        {
                                            <span>@chuyen.LoTrinh.TramDiNavigation.TenTram → @chuyen.LoTrinh.TramToiNavigation.TenTram</span>
                                        }
                                        else
                                        {
                                            <span class="text-muted">Không có dữ liệu</span>
                                        }
                                    </td>

                                    <td>
                                        @chuyen.NgayDi.ToString("dd/MM/yyyy") <br />
                                        <span class="text-primary fw-semibold">@chuyen.GioDi.ToString(@"hh\:mm")</span>
                                    </td>

                                    <td>@(chuyen.Xe?.BienSoXe ?? "Không có xe")</td>

                                    <td>
                                        <span class="badge
                                            @(chuyen.TrangThai == TrangThaiChuyenXe.DaHoanThanh ? "bg-success" :
                                              chuyen.TrangThai == TrangThaiChuyenXe.DangDiChuyen ? "bg-primary" :
                                              chuyen.TrangThai == TrangThaiChuyenXe.ChoKhoiHanh ? "bg-warning text-dark" :
                                              "bg-secondary")">
                                            @Html.DisplayFor(m => chuyen.TrangThai)
                                        </span>
                                    </td>

                                    <td class="text-danger fw-semibold">Chưa phân công</td>

                                    <td>
                                        <form asp-action="PhanCongLich" method="post" class="d-flex gap-2">
                                            @Html.AntiForgeryToken()
                                            <input type="hidden" name="chuyenId" value="@chuyen.ChuyenId" />

                                            <select name="taiXeId" class="form-select form-select-sm select-driver" required>
                                                <option value="">-- Chọn --</option>
                                                @foreach (var tx in taiXes)
                                                {
                                                    <option value="@tx.Value">@tx.Text</option>
                                                }
                                            </select>

                                            <button type="submit" class="btn btn-success btn-sm btn-modern">
                                                <i class="fas fa-user-check"></i> OK
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                            }
                        </tbody>

                    </table>
                </div>
            }
        </div>
    </div>

    <!-- XEM LỊCH TÀI XẾ -->
    <div class="card card-custom">
        <div class="card-header bg-dark text-white py-3">
            <h5 class="mb-0 fw-semibold"><i class="bi bi-calendar3"></i> Lịch Làm Việc Tài Xế</h5>
        </div>
        <div>
            <label class="fw-semibold mb-2">Chọn Tài Xế</label>
            <select id="taiXeSelect" class="form-select select-driver">
                <option value="">-- Chọn tài xế --</option>
                @foreach (var tx in (SelectList)ViewBag.TaiXes)
                {
                    <option value="@tx.Value">@tx.Text</option>
                }
            </select>
        </div>
        <div id="lichTaiXeContainer"
             class="schedule-box"
             data-url="@Url.Action("XemLichTaiXe", "TaiXe", new { area = "TaiXe" })">
        </div>
    </div>
</div>


@section Scripts {
    <script>
        const taiXeSelect = document.getElementById("taiXeSelect");
        const container = document.getElementById("lichTaiXeContainer");

        const xemLichUrl = container.dataset.url;

        taiXeSelect.addEventListener("change", function () {
            const taiXeId = this.value;
            if (!taiXeId) {
                container.innerHTML = "";
                return;
            }

            container.innerHTML = "<div class'text-primary'>Đang tải dữ liệu...</div>";

            fetch(`${xemLichUrl}?taiXeId=${taiXeId}`)
                .then(res => res.text())
                .then(html => container.innerHTML = html)
                .catch(() => {
                    container.innerHTML = "<div class='alert alert-danger'>Lỗi khi tải lịch làm việc.</div>";
                });
        });
    </script>
}