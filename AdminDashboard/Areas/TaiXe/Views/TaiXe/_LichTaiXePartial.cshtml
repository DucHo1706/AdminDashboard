@using AdminDashboard.Models.TrangThai
@model IEnumerable<AdminDashboard.Models.ChuyenXe>

<style>
    .schedule-grid {
        width: 100%;
        border-collapse: collapse;
        table-layout: fixed; /* Giúp các cột bằng nhau */
    }

        .schedule-grid th, .schedule-grid td {
            border: 1px solid #dee2e6;
            padding: 8px;
            text-align: center;
            vertical-align: top;
            height: 60px; /* Chiều cao tối thiểu cho mỗi ô giờ */
        }

        /* Tiêu đề cột (Ngày) */
        .schedule-grid thead th {
            background-color: #f8f9fc;
            font-weight: 700;
            font-size: 0.9rem;
        }

        /* Cột đầu tiên (Giờ) */
        .schedule-grid tbody th {
            background-color: #f8f9fc;
            font-weight: 700;
            width: 80px; /* Cố định chiều rộng cột Giờ */
            font-size: 0.9rem;
        }

        .schedule-grid tbody td {
            text-align: left;
            padding: 0; /* Xóa padding để .trip-cell chiếm toàn bộ */
            position: relative; /* Cho phép định vị tuyệt đối */
        }

    /* Thẻ chuyến xe bên trong ô */
    .trip-cell {
        background-color: #e6f0ff;
        border-left: 4px solid #0d6efd;
        padding: 8px;
        height: 100%; /* Chiếm toàn bộ chiều cao <td> */
        overflow: hidden; /* Ẩn nội dung nếu quá dài */
        font-size: 0.85rem;
    }

    .trip-cell-dang-di-chuyen {
        background-color: #d1fae5;
        border-left-color: #10b981;
    }

    .trip-cell-da-hoan-thanh {
        background-color: #f3f4f6;
        border-left-color: #6b7280;
        opacity: 0.7;
    }

    .trip-cell h6 {
        font-weight: 700;
        font-size: 0.9rem;
        margin-bottom: 4px;
        color: #0d6efd;
    }

    .trip-cell p {
        margin: 0;
        line-height: 1.4;
    }

</style>


@if (!Model.Any())
{
    <div class="alert alert-info">Tài xế chưa có chuyến xe nào được phân công.</div>
}
else
{
    var trips = Model.OrderBy(c => c.NgayDi).ThenBy(c => c.GioDi).ToList();

   var daysToShow = trips.Select(c => c.NgayDi.Date).Distinct().OrderBy(d => d).ToList();

    var minHour = (int)trips.Min(c => c.GioDi.TotalHours);
    var maxHour = (int)Math.Ceiling(trips.Max(c => c.GioDenDuKien.TotalHours));

    var hoursToShow = Enumerable.Range(minHour, maxHour - minHour).ToList();

    var occupiedCells = new HashSet<(DateTime Date, int Hour)>();

    <div class="table-responsive">
        <table class="schedule-grid">

            <thead>
                <tr>
                    <th>Giờ</th> @foreach (var day in daysToShow)
                    {
                        <th>
                            @day.ToString("dddd")<br />
                            @day.ToString("dd/MM")
                        </th>
                    }
                </tr>
            </thead>

            <tbody>
                @foreach (var hour in hoursToShow)
                {
                    <tr>
                        <th>@TimeSpan.FromHours(hour).ToString(@"hh\:mm")</th>

                        @foreach (var day in daysToShow)
                        {
                            if (occupiedCells.Contains((day, hour)))
                            {
                                continue;
                            }

                            var trip = trips.FirstOrDefault(c =>
                            c.NgayDi.Date == day &&
                            (int)c.GioDi.TotalHours == hour);

                            if (trip != null)
                            {
                                var startHour = (int)trip.GioDi.TotalHours;
                                var endHour = (int)Math.Ceiling(trip.GioDenDuKien.TotalHours);
                                var rowSpan = Math.Max(1, endHour - startHour); 
                                for (int i = 1; i < rowSpan; i++)
                                {
                                    occupiedCells.Add((day, hour + i));
                                }

                                string cellClass = "";
                                if (trip.TrangThai == TrangThaiChuyenXe.DangDiChuyen)
                                {
                                    cellClass = "trip-cell-dang-di-chuyen";
                                }
                                else if (trip.TrangThai == TrangThaiChuyenXe.DaHoanThanh)
                                {
                                    cellClass = "trip-cell-da-hoan-thanh";
                                }

                                <td rowspan="@rowSpan">
                                    <div class="trip-cell @cellClass">
                                        <h6>@trip.GioDi.ToString(@"hh\:mm") - @trip.GioDenDuKien.ToString(@"hh\:mm")</h6>
                                        <p>
                                            <strong>
                                                @(trip.LoTrinh?.TramDiNavigation?.TenTram ?? "...") →
                                                @(trip.LoTrinh?.TramToiNavigation?.TenTram ?? "...")
                                            </strong>
                                        </p>
                                        <p>Xe: @(trip.Xe?.BienSoXe ?? "N/A")</p>
                                        <p>Trạng thái: @trip.TrangThai</p>
                                    </div>
                                </td>
                            }
                            else
                            {
                                <td></td>
                            }
                        }
                    </tr>
                }
            </tbody>
        </table>
    </div>
}