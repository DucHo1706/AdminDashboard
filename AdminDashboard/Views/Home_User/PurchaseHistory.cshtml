@model IEnumerable<AdminDashboard.Models.DonHang>

@{
    ViewData["Title"] = "Lịch sử mua vé";
}

<div class="container my-4">
    <h3 class="mb-3">Lịch sử mua vé</h3>

    <ul class="nav nav-pills mb-3" id="historyTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="tab-current" data-bs-toggle="pill" data-bs-target="#pane-current" type="button" role="tab">Hiện tại</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dadi" data-bs-toggle="pill" data-bs-target="#pane-dadi" type="button" role="tab">Đã đi</button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="tab-dahuy" data-bs-toggle="pill" data-bs-target="#pane-dahuy" type="button" role="tab">Đã hủy</button>
        </li>
    </ul>

    @if (Model == null || !Model.Any())
    {
        <div class="alert alert-info">Bạn chưa có đơn hàng nào.</div>
    }
    else
    {
        var hienTai = Model
            .Where(d => d.ChuyenXe != null)
            .Where(d => d.ChuyenXe.TrangThai != AdminDashboard.Models.TrangThai.TrangThaiChuyenXe.DaHoanThanh)
            .Where(d => d.TrangThaiThanhToan == "DangChoThanhToan" || d.TrangThaiThanhToan == "Đã thanh toán")
            .OrderBy(d => d.ChuyenXe.NgayDi).ThenBy(d => d.ChuyenXe.GioDi);

        var daDi = Model
            .Where(d => d.ChuyenXe != null)
            .Where(d => d.TrangThaiThanhToan == "Đã thanh toán")
            .Where(d => d.ChuyenXe.TrangThai == AdminDashboard.Models.TrangThai.TrangThaiChuyenXe.DaHoanThanh || d.ChuyenXe.NgayDi < DateTime.Today)
            .OrderByDescending(d => d.ChuyenXe.NgayDi);
        var daHuy = Model.Where(d => d.TrangThaiThanhToan == "Đã hủy" || d.TrangThaiThanhToan == "Giao dịch thất bại");

        <div class="tab-content">
            <div class="tab-pane fade show active" id="pane-current" role="tabpanel">
                <div class="row g-3">
                @foreach (var d in hienTai)
                {
            var isPaid = string.Equals(d.TrangThaiThanhToan, "Đã thanh toán", StringComparison.OrdinalIgnoreCase);
            var isPending = string.Equals(d.TrangThaiThanhToan, "DangChoThanhToan", StringComparison.OrdinalIgnoreCase);
            var isCancelled = string.Equals(d.TrangThaiThanhToan, "Đã hủy", StringComparison.OrdinalIgnoreCase);

            var border = isPaid ? "border-success" : (isPending ? "border-warning" : "border-secondary");
            var header = isPaid ? "bg-success" : (isPending ? "bg-warning" : "bg-secondary");
            var statusText = isPaid ? "Đã thanh toán" : (isPending ? "Chờ thanh toán" : "Đã hủy");
            var badge = isPaid ? "bg-success" : (isPending ? "bg-warning text-dark" : "bg-secondary");

            <div class="col-12">
                <div class="card shadow-sm @border">
                    <div class="card-header text-white @header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Mã đơn:</strong> @d.DonHangId
                        </div>
                        <span class="badge @badge">@statusText</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Ngày đặt:</strong> @d.NgayDat.ToString("dd/MM/yyyy HH:mm")</div>
                                <div class="mb-2"><strong>Tổng tiền:</strong> <span class="text-danger fw-semibold">@d.TongTien.ToString("N0") VNĐ</span></div>
                                @if (isPending)
                                {
                                    <div class="mb-2 text-danger fw-semibold">
                                        <span>Thời gian thanh toán còn lại: </span>
                                        <span class="countdown" data-expire="@d.ThoiGianHetHan.ToString("o")" data-order="@d.DonHangId" data-pending="1">--:--</span>
                                    </div>
                                }
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Tuyến:</strong> @d.ChuyenXe?.LoTrinh?.TramDiNavigation?.TenTram - @d.ChuyenXe?.LoTrinh?.TramToiNavigation?.TenTram</div>
                                <div class="mb-2"><strong>Thời gian:</strong> @d.ChuyenXe?.NgayDi.ToString("dd/MM/yyyy") @d.ChuyenXe?.GioDi</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end gap-2">
                        <a asp-controller="Booking" asp-action="BookingSuccess" asp-route-id="@d.DonHangId" class="btn btn-outline-primary btn-sm">Chi tiết</a>
                        @if (isPending)
                        {
                            <form asp-controller="Booking" asp-action="PayAgain" method="post" class="d-inline">
                                <input type="hidden" name="id" value="@d.DonHangId" />
                                <button type="submit" class="btn btn-danger btn-sm">Thanh toán lại</button>
                            </form>
                            <form asp-controller="Booking" asp-action="CancelOrder" method="post" class="d-inline" id="cancel-@d.DonHangId">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="id" value="@d.DonHangId" />
                                <button type="submit" class="btn btn-outline-secondary btn-sm">Hủy mua vé</button>
                            </form>
                        }
                    </div>
                </div>
            </div>
        }
                </div>
            </div>

            <div class="tab-pane fade" id="pane-dadi" role="tabpanel">
                <div class="row g-3">
                @foreach (var d in daDi)
                {
                    var isPaid = true; var isPending = false; var isCancelled = false;
                    var border = "border-success"; var header = "bg-success"; var statusText = "Đã thanh toán"; var badge = "bg-success";
            <div class="col-12">
                <div class="card shadow-sm @border">
                    <div class="card-header text-white @header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Mã đơn:</strong> @d.DonHangId
                        </div>
                        <span class="badge @badge">@statusText</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Ngày đặt:</strong> @d.NgayDat.ToString("dd/MM/yyyy HH:mm")</div>
                                <div class="mb-2"><strong>Tổng tiền:</strong> <span class="text-danger fw-semibold">@d.TongTien.ToString("N0") VNĐ</span></div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Tuyến:</strong> @d.ChuyenXe?.LoTrinh?.TramDiNavigation?.TenTram - @d.ChuyenXe?.LoTrinh?.TramToiNavigation?.TenTram</div>
                                <div class="mb-2"><strong>Thời gian:</strong> @d.ChuyenXe?.NgayDi.ToString("dd/MM/yyyy") @d.ChuyenXe?.GioDi</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end gap-2">
                        <a asp-controller="Booking" asp-action="BookingSuccess" asp-route-id="@d.DonHangId" class="btn btn-outline-primary btn-sm">Xem vé điện</a>
                        <a asp-controller="Home_User" asp-action="Home_User" class="btn btn-primary btn-sm">Đặt chuyến</a>
                    </div>
                </div>
            </div>
                }
                </div>
            </div>

            <div class="tab-pane fade" id="pane-dahuy" role="tabpanel">
                <div class="row g-3">
                @foreach (var d in daHuy)
                {
                    var isPaid = false; var isPending = false; var isCancelled = true;
                    var border = "border-secondary"; var header = "bg-secondary"; var statusText = "Đã hủy"; var badge = "bg-secondary";
            <div class="col-12">
                <div class="card shadow-sm @border">
                    <div class="card-header text-white @header d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Mã đơn:</strong> @d.DonHangId
                        </div>
                        <span class="badge @badge">@statusText</span>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Ngày đặt:</strong> @d.NgayDat.ToString("dd/MM/yyyy HH:mm")</div>
                                <div class="mb-2"><strong>Tổng tiền:</strong> <span class="text-danger fw-semibold">@d.TongTien.ToString("N0") VNĐ</span></div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2"><strong>Tuyến:</strong> @d.ChuyenXe?.LoTrinh?.TramDiNavigation?.TenTram - @d.ChuyenXe?.LoTrinh?.TramToiNavigation?.TenTram</div>
                                <div class="mb-2"><strong>Thời gian:</strong> @d.ChuyenXe?.NgayDi.ToString("dd/MM/yyyy") @d.ChuyenXe?.GioDi</div>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer d-flex justify-content-end gap-2">
                        <a asp-controller="Home_User" asp-action="Home_User" class="btn btn-primary btn-sm">Đặt chuyến</a>
                    </div>
                </div>
            </div>
                }
                </div>
            </div>
        </div>
    }
</div>

<script>
    (function () {
        const nodes = document.querySelectorAll('.countdown');
        if (!nodes.length) return;

        function format(ms) {
            if (ms <= 0) return '00:00:00';
            const totalSec = Math.floor(ms / 1000);
            const h = String(Math.floor(totalSec / 3600)).padStart(2, '0');
            const m = String(Math.floor((totalSec % 3600) / 60)).padStart(2, '0');
            const s = String(totalSec % 60).padStart(2, '0');
            return `${h}:${m}:${s}`;
        }

        function tick() {
            const now = new Date();
            nodes.forEach(el => {
                const expire = new Date(el.getAttribute('data-expire'));
                const remain = expire - now;
                if (remain <= 0) {
                    el.textContent = 'Hết hạn';
                    // Giữ nguyên tab hiện tại, KHÔNG tự chuyển sang Đã hủy
                } else {
                    el.textContent = format(remain);
                }
            });
        }
        tick();
        setInterval(tick, 1000);
    })();
</script>
