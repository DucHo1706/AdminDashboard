@model AdminDashboard.Models.Tram

<h2>Thêm Trạm</h2>

<form asp-action="Create">
    <div class="form-group">
        <label asp-for="TenTram" class="control-label"></label>
        <input asp-for="TenTram" class="form-control" />
        <span asp-validation-for="TenTram" class="text-danger"></span>
    </div>

    <div class="form-group">
        <label class="control-label">Tỉnh/Thành phố</label>
        <select id="province" class="form-control" required>
            <option value="">Chọn Tỉnh/Thành phố</option>
        </select>
        @Html.HiddenFor(model => model.Tinh, new { id = "hiddenTinh" })
        <span class="text-danger" id="provinceValidation" style="display:none;">Vui lòng chọn tỉnh/thành phố</span>
    </div>

    <div class="form-group">
        <label class="control-label">Quận/Huyện</label>
        <select id="district" class="form-control" disabled required>
            <option value="">Chọn Quận/Huyện</option>
        </select>
        @Html.HiddenFor(model => model.Huyen, new { id = "hiddenHuyen" })
        <span class="text-danger" id="districtValidation" style="display:none;">Vui lòng chọn quận/huyện</span>
    </div>

    <div class="form-group">
        <label class="control-label">Phường/Xã</label>
        <select id="ward" class="form-control" disabled required>
            <option value="">Chọn Phường/Xã</option>
        </select>
        @Html.HiddenFor(model => model.Xa, new { id = "hiddenXa" })
        <span class="text-danger" id="wardValidation" style="display:none;">Vui lòng chọn phường/xã</span>
    </div>

    <div class="form-group">
        <label class="control-label">Địa chỉ chi tiết (Số nhà, tên đường)</label>
        <input id="detailAddress" class="form-control" required />
        <span class="text-danger" id="detailAddressValidation" style="display:none;">Vui lòng nhập địa chỉ chi tiết</span>
    </div>

     @Html.HiddenFor(model => model.DiaChiTram, new { id = "fullAddress" })

    <div class="form-group mt-3">
        <button type="submit" class="btn btn-primary" onclick="return validateForm()">Lưu</button>
        <a asp-action="Index" class="btn btn-secondary">Quay lại</a>
    </div>
</form>

@section Scripts {
    <script>
         const provinceApi = 'https://provinces.open-api.vn/api/p/';
        const districtApi = 'https://provinces.open-api.vn/api/d/';
        const wardApi = 'https://provinces.open-api.vn/api/w/';

         async function loadProvinces() {
            try {
                const response = await fetch(provinceApi);
                const provinces = await response.json();
                const provinceSelect = document.getElementById('province');

                provinces.forEach(province => {
                    const option = document.createElement('option');
                    option.value = province.code;
                    option.textContent = province.name;
                    provinceSelect.appendChild(option);
                });
            } catch (error) {
                console.error('Lỗi khi tải danh sách tỉnh/thành phố:', error);
            }
        }

         async function loadDistricts(provinceCode) {
            try {
                const response = await fetch(`${provinceApi}${provinceCode}?depth=2`);
                const province = await response.json();
                const districtSelect = document.getElementById('district');

                districtSelect.innerHTML = '<option value="">Chọn Quận/Huyện</option>';
                districtSelect.disabled = false;

                province.districts.forEach(district => {
                    const option = document.createElement('option');
                    option.value = district.code;
                    option.textContent = district.name;
                    districtSelect.appendChild(option);
                });

                 const wardSelect = document.getElementById('ward');
                wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
                wardSelect.disabled = true;
                document.getElementById('hiddenXa').value = '';

                combineAddress();
            } catch (error) {
                console.error('Lỗi khi tải danh sách quận/huyện:', error);
            }
        }

         async function loadWards(districtCode) {
            try {
                const response = await fetch(`${districtApi}${districtCode}?depth=2`);
                const district = await response.json();
                const wardSelect = document.getElementById('ward');

                wardSelect.innerHTML = '<option value="">Chọn Phường/Xã</option>';
                wardSelect.disabled = false;

                district.wards.forEach(ward => {
                    const option = document.createElement('option');
                    option.value = ward.code;
                    option.textContent = ward.name;
                    wardSelect.appendChild(option);
                });

                combineAddress();
            } catch (error) {
                console.error('Lỗi khi tải danh sách phường/xã:', error);
            }
        }

        // Hàm kết hợp địa chỉ
        function combineAddress() {
            const provinceSelect = document.getElementById('province');
            const districtSelect = document.getElementById('district');
            const wardSelect = document.getElementById('ward');
            const detailAddress = document.getElementById('detailAddress').value;

            const provinceText = provinceSelect.options[provinceSelect.selectedIndex]?.textContent || '';
            const districtText = districtSelect.options[districtSelect.selectedIndex]?.textContent || '';
            const wardText = wardSelect.options[wardSelect.selectedIndex]?.textContent || '';

            // Cập nhật các trường ẩn
            document.getElementById('hiddenTinh').value = provinceText;
            document.getElementById('hiddenHuyen').value = districtText;
            document.getElementById('hiddenXa').value = wardText;

            // Tạo địa chỉ đầy đủ
            const fullAddress = [detailAddress, wardText, districtText, provinceText]
                .filter(part => part && part.trim() !== '')
                .join(', ');

            document.getElementById('fullAddress').value = fullAddress;
        }

         function validateForm() {
            let isValid = true;

             document.getElementById('provinceValidation').style.display = 'none';
            document.getElementById('districtValidation').style.display = 'none';
            document.getElementById('wardValidation').style.display = 'none';
            document.getElementById('detailAddressValidation').style.display = 'none';

            // Validate province
            if (!document.getElementById('province').value) {
                document.getElementById('provinceValidation').style.display = 'block';
                isValid = false;
            }

            // Validate district
            if (!document.getElementById('district').value) {
                document.getElementById('districtValidation').style.display = 'block';
                isValid = false;
            }

            // Validate ward
            if (!document.getElementById('ward').value) {
                document.getElementById('wardValidation').style.display = 'block';
                isValid = false;
            }

             if (!document.getElementById('detailAddress').value.trim()) {
                document.getElementById('detailAddressValidation').style.display = 'block';
                isValid = false;
            }

            if (!isValid) {
                alert('Vui lòng điền đầy đủ thông tin địa chỉ.');
            }

            return isValid;
        }

         document.addEventListener('DOMContentLoaded', function() {
            loadProvinces();

            document.getElementById('province').addEventListener('change', function() {
                if (this.value) {
                    loadDistricts(this.value);
                } else {
                    document.getElementById('district').disabled = true;
                    document.getElementById('ward').disabled = true;
                    document.getElementById('hiddenHuyen').value = '';
                    document.getElementById('hiddenXa').value = '';
                    combineAddress();
                }
            });

            document.getElementById('district').addEventListener('change', function() {
                if (this.value) {
                    loadWards(this.value);
                } else {
                    document.getElementById('ward').disabled = true;
                    document.getElementById('hiddenXa').value = '';
                    combineAddress();
                }
            });

            document.getElementById('ward').addEventListener('change', combineAddress);
            document.getElementById('detailAddress').addEventListener('input', combineAddress);
        });
    </script>
}